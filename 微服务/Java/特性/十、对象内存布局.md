## 1.**Java对象内存布局和对象头**

### 1.面试题

- 说下JUC，AQS的大致流程
- CAS自旋锁，是获取不到锁就一直自旋吗？CAS和synchronized区别在哪里，为什么CAS好，具体优势在哪里？
- sychronized底层是如何实现的，实现同步的时候用到了CAS 了吗？具体哪里用到了？
- 对象头存储那些信息？长度是多少位存储？

## 2.Object object = new Object()谈谈你对这句话的理解？

- 位置所在-------->JVM堆->新生区->伊甸园区
- 构成布局-------->对象头+实例数据+对齐填充

## 3.对象在堆内存中布局

### 1.权威定义----周志明老师JVM

在HotSpot虚拟机里，对象在堆内存的存储布局可以划分为三个部分：对象头（Header）、实例数据（Instance Data） 和对齐填充（Padding，8字节的倍数）。如果一个对象只有markword、类型指针构成，只有16个字节大小，例如object。

![image.png](https://cdn.nlark.com/yuque/0/2023/png/35653686/1681442187170-c371a7b9-fa6a-477a-b7f5-6ea12ce59281.png)

### 2.对象在堆内存中的存储布局

![image-20231212160703782](../../../../../picbed/store/picbed/img/image-20231212160703782.png)

- **对象头**（在64位系统中，Mark Word占了8个字节，类型指针占了8个字节，一共是16个字节）

  ![image.png](https://cdn.nlark.com/yuque/0/2023/png/35653686/1681442831019-c219d11a-c62e-4ddc-a378-069a233ed7f3.png?x-oss-process=image%2Fresize%2Cw_927%2Climit_0)

- - 对象标记（Mark Word）

    ![image-20231212160006634](../../../../../picbed/store/picbed/img/image-20231212160006634.png)

- - - 默认存储对象的HashCode、分代年龄和锁标志等信息。
    - 这些信息都是与对象自身定义无关的数据，所以Mark Word被设计成一个非固定的数据结构以便在极小的空间内存存储尽量多的数据。
    - 它会根据对象的状态复用自己的存储空间，也就是说在运行期间MarkWord里存储的数据会随着锁标志位的变化而变化。

- - 类元信息（类型指针）

- - - 对象指向它的类元数据的指针，虚拟机通过这个指针来确定这个对象哪个类的实例

- **实例数据**

- - 存放类的**属性（Field）数据信息**，**包括父类的属性信息**

- **对齐填充**（保证8个字节的倍数）

- - 虚拟机要求对象起始地址**必须是8字节的整数倍**，填充数据不是必须存在的，仅仅是为了字节对齐，这部分内存按8字节补充对齐。

## 4.再说对象头的MarkWord

markOop.cpp

![image-20231212162724650](../../../../../picbed/store/picbed/img/image-20231212162724650.png)

age：保存对象的分代年龄，4位，最大值15，经过15次gc后仍然存在进入老年代。

在64位虚拟机下，MarkWord大小是64bit：

![image.png](https://cdn.nlark.com/yuque/0/2023/png/35653686/1681443457091-02bfb636-4c94-44d4-b56a-99485c94318b.png?x-oss-process=image%2Fresize%2Cw_1125%2Climit_0)

## 5.聊聊Object obj = new Object()

### 1.JOL：java object layout工具，分析对象的大小和分布

- 使用：

  ```xml
  		<dependency>
              <groupId>org.openjdk.jol</groupId>
              <artifactId>jol-core</artifactId>
              <version>0.17</version>
          </dependency>
  ```

  ```java
  public class JolDeno {
      public static void main(String[] args) {
          Object o = new Object();
          System.out.println(ClassLayout.parseInstance(o).toPrintable());
      }
  }
  
  java.lang.Object object internals:
  OFF  SZ   TYPE DESCRIPTION               VALUE
    0   8        (object header: mark)     0x0000000000000005 (biasable; age: 0)
    8   4        (object header: class)    0x00001000
   12   4        (object alignment gap)    
  Instance size: 16 bytes
  Space losses: 0 bytes internal + 4 bytes external = 4 bytes total
  ```

  ![image-20231212163758356](../../../../../picbed/store/picbed/img/image-20231212163758356.png)

![image-20231212163841072](../../../../../picbed/store/picbed/img/image-20231212163841072.png)

普通对象（没有属性时）：

```java
public class JolDemo {
    public static void main(String[] args) {
        Cust cust = new Cust();
        System.out.println(ClassLayout.parseInstance(cust).toPrintable());
    }
}

class Cust{
}

com.example.demo.Cust object internals:
OFF  SZ   TYPE DESCRIPTION               VALUE
  0   8        (object header: mark)     0x0000000000000001 (non-biasable; age: 0)
  8   4        (object header: class)    0x01003200
 12   4        (object alignment gap)    
Instance size: 16 bytes
Space losses: 0 bytes internal + 4 bytes external = 4 bytes total
```

普通对象（有属性时）：

```java
class Cust{
    int id;
    boolean flag = false;
}

com.example.demo.Cust object internals:
OFF  SZ      TYPE DESCRIPTION               VALUE
  0   8           (object header: mark)     0x0000000000000001 (non-biasable; age: 0)
  8   4           (object header: class)    0x01003200
 12   4       int Cust.id                   0
 16   1   boolean Cust.flag                 false
 17   7           (object alignment gap)    
Instance size: 24 bytes
Space losses: 0 bytes internal + 7 bytes external = 7 bytes total
```

### 2.GC年龄最大值为15，为什么是15？不是15行不行？

age由4bit，最大1111，即为15，大于15会被报错，创建虚拟机失败。

### 3.压缩指针

- Java -XX:+PrintCommandLineFlags -version 查看当前虚拟机信息

  ```cmd
  -XX:ConcGCThreads=4 -XX:G1ConcRefinementThreads=15 -XX:GCDrainStackTargetSize=64 -XX:InitialHeapSize=532356992 -XX:MarkStackSize=4194304 -XX:MaxHeapSize=8517711872 -XX:MinHeapSize=6815736 -XX:+PrintCommandLineFlags -XX:ReservedCodeCacheSize=251658240 -XX:+SegmentedCodeCache -XX:+UseCompressedOops -XX:+UseG1GC -XX:-UseLargePagesIndividualAllocation 
  java version "21.0.1" 2023-10-17 LTS
  Java(TM) SE Runtime Environment (build 21.0.1+12-LTS-29)
  Java HotSpot(TM) 64-Bit Server VM (build 21.0.1+12-LTS-29, mixed mode, sharing)
  ```

- **默认开启压缩指针，开启后将上述类型指针压缩为4字节**，以节约空间

- 手动关闭压缩指针： **-XX: -UseCompressedClassPointers**


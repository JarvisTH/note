<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>29-ç†è®ºä¸‰ï¼šä»€ä¹ˆæ˜¯ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Ÿå¦‚ä½•å†™å‡ºå¯æµ‹è¯•æ€§å¥½çš„ä»£ç ï¼Ÿ</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <style>
        html {
            color: #333;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-rendering: optimizelegibility;
            font-family: Helvetica Neue, PingFang SC, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif
        }

        html.borderbox *,
        html.borderbox :after,
        html.borderbox :before {
            box-sizing: border-box
        }

        article,
        aside,
        blockquote,
        body,
        button,
        code,
        dd,
        details,
        dl,
        dt,
        fieldset,
        figcaption,
        figure,
        footer,
        form,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        header,
        hr,
        input,
        legend,
        li,
        menu,
        nav,
        ol,
        p,
        pre,
        section,
        td,
        textarea,
        th,
        ul {
            margin: 0;
            padding: 0
        }

        article,
        aside,
        details,
        figcaption,
        figure,
        footer,
        header,
        menu,
        nav,
        section {
            display: block
        }

        audio,
        canvas,
        video {
            display: inline-block
        }

        body,
        button,
        input,
        select,
        textarea {
            font: 300 1em/1.8 PingFang SC, Lantinghei SC, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, Helvetica, sans-serif
        }

        button::-moz-focus-inner,
        input::-moz-focus-inner {
            padding: 0;
            border: 0
        }

        table {
            border-collapse: collapse;
            border-spacing: 0
        }

        fieldset,
        img {
            border: 0
        }

        blockquote {
            position: relative;
            color: #999;
            font-weight: 400;
            border-left: 1px solid #1abc9c;
            padding-left: 1em;
            margin: 1em 3em 1em 2em
        }

        @media only screen and (max-width: 640px) {
            blockquote {
                margin: 1em 0
            }
        }

        abbr,
        acronym {
            border-bottom: 1px dotted;
            font-variant: normal
        }

        abbr {
            cursor: help
        }

        del {
            text-decoration: line-through
        }

        address,
        caption,
        cite,
        code,
        dfn,
        em,
        th,
        var {
            font-style: normal;
            font-weight: 400
        }

        ol,
        ul {
            list-style: none
        }

        caption,
        th {
            text-align: left
        }

        q:after,
        q:before {
            content: ""
        }

        sub,
        sup {
            font-size: 75%;
            line-height: 0;
            position: relative
        }

        :root sub,
        :root sup {
            vertical-align: baseline
        }

        sup {
            top: -.5em
        }

        sub {
            bottom: -.25em
        }

        a {
            color: #1abc9c
        }

        a:hover {
            text-decoration: underline
        }

        .typo a {
            border-bottom: 1px solid #1abc9c
        }

        .typo a:hover {
            border-bottom-color: #555;
            color: #555
        }

        .typo a:hover,
        a,
        ins {
            text-decoration: none
        }

        .typo-u,
        u {
            text-decoration: underline
        }

        mark {
            background: #fffdd1;
            border-bottom: 1px solid #ffedce;
            padding: 2px;
            margin: 0 5px
        }

        code,
        pre,
        pre tt {
            font-family: Courier, Courier New, monospace
        }

        pre {
            background: hsla(0, 0%, 97%, .7);
            border: 1px solid #ddd;
            padding: 1em 1.5em;
            display: block;
            -webkit-overflow-scrolling: touch
        }

        hr {
            border: none;
            border-bottom: 1px solid #cfcfcf;
            margin-bottom: .8em;
            height: 10px
        }

        .typo-small,
        figcaption,
        small {
            font-size: .9em;
            color: #888
        }

        b,
        strong {
            font-weight: 700;
            color: #000
        }

        [draggable] {
            cursor: move
        }

        .clearfix:after,
        .clearfix:before {
            content: "";
            display: table
        }

        .clearfix:after {
            clear: both
        }

        .clearfix {
            zoom: 1
        }

        .textwrap,
        .textwrap td,
        .textwrap th {
            word-wrap: break-word;
            word-break: break-all
        }

        .textwrap-table {
            table-layout: fixed
        }

        .serif {
            font-family: Palatino, Optima, Georgia, serif
        }

        .typo-dl,
        .typo-form,
        .typo-hr,
        .typo-ol,
        .typo-p,
        .typo-pre,
        .typo-table,
        .typo-ul,
        .typo dl,
        .typo form,
        .typo hr,
        .typo ol,
        .typo p,
        .typo pre,
        .typo table,
        .typo ul,
        blockquote {
            margin-bottom: 1rem
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: PingFang SC, Helvetica Neue, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif;
            color: #000;
            line-height: 1.35
        }

        .typo-h1,
        .typo-h2,
        .typo-h3,
        .typo-h4,
        .typo-h5,
        .typo-h6,
        .typo h1,
        .typo h2,
        .typo h3,
        .typo h4,
        .typo h5,
        .typo h6 {
            margin-top: 1.2em;
            margin-bottom: .6em;
            line-height: 1.35
        }

        .typo-h1,
        .typo h1 {
            font-size: 2em
        }

        .typo-h2,
        .typo h2 {
            font-size: 1.8em
        }

        .typo-h3,
        .typo h3 {
            font-size: 1.6em
        }

        .typo-h4,
        .typo h4 {
            font-size: 1.4em
        }

        .typo-h5,
        .typo-h6,
        .typo h5,
        .typo h6 {
            font-size: 1.2em
        }

        .typo-ul,
        .typo ul {
            margin-left: 1.3em;
            list-style: disc
        }

        .typo-ol,
        .typo ol {
            list-style: decimal;
            margin-left: 1.9em
        }

        .typo-ol ol,
        .typo-ol ul,
        .typo-ul ol,
        .typo-ul ul,
        .typo li ol,
        .typo li ul {
            margin-bottom: .8em;
            margin-left: 2em
        }

        .typo-ol ul,
        .typo-ul ul,
        .typo li ul {
            list-style: circle
        }

        .typo-table td,
        .typo-table th,
        .typo table caption,
        .typo table td,
        .typo table th {
            border: 1px solid #ddd;
            padding: .5em 1em;
            color: #666
        }

        .typo-table th,
        .typo table th {
            background: #fbfbfb
        }

        .typo-table thead th,
        .typo table thead th {
            background: hsla(0, 0%, 95%, .7)
        }

        .typo table caption {
            border-bottom: none
        }

        .typo-input,
        .typo-textarea {
            -webkit-appearance: none;
            border-radius: 0
        }

        .typo-em,
        .typo em,
        caption,
        legend {
            color: #000;
            font-weight: inherit
        }

        .typo-em {
            position: relative
        }

        .typo-em:after {
            position: absolute;
            top: .65em;
            left: 0;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            content: "\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB"
        }

        .typo img {
            max-width: 100%
        }

        .common-content {
            font-weight: 400;
            color: #353535;
            line-height: 1.75rem;
            white-space: normal;
            word-break: normal;
            font-size: 1rem
        }

        .common-content img {
            display: block;
            max-width: 100%;
            background-color: #eee
        }

        .common-content audio,
        .common-content video {
            width: 100%;
            background-color: #eee
        }

        .common-content center,
        .common-content font {
            margin-top: 1rem;
            display: inline-block
        }

        .common-content center {
            width: 100%
        }

        .common-content pre {
            margin-top: 1rem;
            padding-left: 0;
            padding-right: 0;
            position: relative;
            overflow: hidden
        }

        .common-content pre code {
            font-size: .8rem;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding-left: 1rem;
            padding-right: 1rem;
            overflow-x: auto
        }

        .common-content hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        .common-content b,
        .common-content h1,
        .common-content h2,
        .common-content h3,
        .common-content h4,
        .common-content h5,
        .common-content strong {
            font-weight: 700
        }

        .common-content h1,
        .common-content h2 {
            font-size: 1.125rem;
            margin-bottom: .45rem
        }

        .common-content h3,
        .common-content h4,
        .common-content h5 {
            font-size: 1rem;
            margin-bottom: .45rem
        }

        .common-content p {
            font-weight: 400;
            color: #353535;
            margin-top: .15rem
        }

        .common-content .orange {
            color: #ff5a05
        }

        .common-content .reference {
            font-size: 1rem;
            color: #888
        }

        .custom-rich-content h1 {
            margin-top: 0;
            font-weight: 400;
            font-size: 15.25px;
            border-bottom: 1px solid #eee;
            line-height: 2.8
        }

        .custom-rich-content li,
        .custom-rich-content p {
            font-size: 14px;
            color: #888;
            line-height: 1.6
        }

        table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        table.hljs-ln,
        table.hljs-ln tbody,
        table.hljs-ln td,
        table.hljs-ln tr {
            box-sizing: border-box
        }

        table.hljs-ln td {
            padding: 0;
            border: 0
        }

        table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            user-select: none
        }

        table.hljs-ln td.hljs-ln-code,
        table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            font-size: 12px;
            line-height: 20px;
            vertical-align: top
        }

        table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            color: #24292e;
            word-wrap: normal;
            white-space: pre
        }

        video::-webkit-media-controls {
            overflow: hidden !important
        }

        video::-webkit-media-controls-enclosure {
            width: calc(100% + 32px);
            margin-left: auto
        }

        ._29HP61GA_0 {
            max-width:800px;
            margin:0 auto;
            margin-bottom: 20px;
            font-weight: 400;
            color: #353535;
            line-height: 1.76;
            white-space: normal;
            word-break: normal;
            font-size: 17px;
            -webkit-transition: background-color .3s ease;
            transition: background-color .3s ease
        }

        ._29HP61GA_0 .MathJax_Display {
            overflow: auto
        }

        ._29HP61GA_0 .poster {
            position: fixed;
            left: -10000px;
            top: -10000px;
            overflow: hidden;
            padding: 1rem;
            background: #ececec
        }

        ._29HP61GA_0 .richcontent-pre-copy {
            font-size: 13px;
            color: #888;
            position: absolute;
            right: 1em;
            top: .5em;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 .richcontent-pre-copy .iconfont {
            font-size: 12px;
            margin-right: .2em
        }

        ._29HP61GA_0 a {
            color: #fa8919;
            border-bottom: 1px solid #fa8919
        }

        ._29HP61GA_0 img {
            display: block;
            max-width: 100%;
            position: relative;
            left: 50%;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            background-color: #eee;
            vertical-align: top;
            border-radius: 0
        }

        ._29HP61GA_0 audio,
        ._29HP61GA_0 video {
            width: 100%;
            background-color: #eee
        }

        ._29HP61GA_0 pre {
            margin-top: 16px;
            padding: 34px 0 0;
            margin-bottom: 30px;
            position: relative;
            border-radius: 6px;
            background: rgba(246, 247, 251, .749);
            border: 0
        }

        ._29HP61GA_0 pre code {
            font-size: 12px;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            margin-left: 16px;
            margin-right: 16px;
            overflow-x: scroll
        }

        ._29HP61GA_0 pre code:after {
            content: "";
            height: 30px;
            width: 100%;
            display: block
        }

        ._29HP61GA_0 hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        ._29HP61GA_0 h1,
        ._29HP61GA_0 h2,
        ._29HP61GA_0 h3,
        ._29HP61GA_0 h4,
        ._29HP61GA_0 h5 {
            margin-bottom: 20px;
            margin-top: 0;
            font-weight: 700
        }

        ._29HP61GA_0 b,
        ._29HP61GA_0 strong {
            font-weight: 700
        }

        ._29HP61GA_0 h1 {
            font-size: 21px
        }

        ._29HP61GA_0 h2 {
            font-size: 20px
        }

        ._29HP61GA_0 h3 {
            font-size: 19px
        }

        ._29HP61GA_0 h4 {
            font-size: 18px
        }

        ._29HP61GA_0 h5 {
            font-size: 17px
        }

        ._29HP61GA_0 center,
        ._29HP61GA_0 p {
            font-weight: 400;
            color: #353535;
            margin-top: 0;
            margin-bottom: 30px;
            word-break: break-word
        }

        ._29HP61GA_0 center {
            text-align: center
        }

        ._29HP61GA_0 blockquote {
            margin-top: 0;
            margin-bottom: 34px;
            border-left: 3px solid #e8e8e8;
            padding-left: 17px;
            color: #353535
        }

        ._29HP61GA_0 blockquote p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol,
        ._29HP61GA_0 ul {
            margin-bottom: 30px
        }

        ._29HP61GA_0 ol p,
        ._29HP61GA_0 ul p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol {
            list-style: decimal;
            margin-left: 20px
        }

        ._29HP61GA_0 ul li {
            padding-left: 17px;
            position: relative;
            margin-bottom: 10px
        }

        ._29HP61GA_0 ul li:after {
            content: "";
            height: 6px;
            width: 6px;
            border-radius: 50%;
            background: #353535;
            position: absolute;
            top: 10px;
            left: 0
        }

        ._29HP61GA_0 .orange {
            color: #fa8919
        }

        ._29HP61GA_0 .reference {
            color: #888
        }

        ._29HP61GA_0 .m-right {
            text-align: right
        }

        ._29HP61GA_0 .m-center {
            text-align: center;
            display: block
        }

        ._29HP61GA_0 .m-gray {
            color: #888
        }

        ._29HP61GA_0 .m-small {
            font-size: 15px
        }

        ._29HP61GA_0 table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        ._29HP61GA_0 table.hljs-ln,
        ._29HP61GA_0 table.hljs-ln tbody,
        ._29HP61GA_0 table.hljs-ln td,
        ._29HP61GA_0 table.hljs-ln tr {
            -webkit-box-sizing: border-box;
            box-sizing: border-box
        }

        ._29HP61GA_0 table.hljs-ln td {
            padding: 0;
            border: 0
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            font-size: 12px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code,
        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            line-height: 20px;
            vertical-align: top
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            font-size: 13px;
            color: #666;
            word-wrap: normal;
            white-space: pre
        }

    </style>
</head>
<body>
<div class="_29HP61GA_0">
<h1>29-ç†è®ºä¸‰ï¼šä»€ä¹ˆæ˜¯ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Ÿå¦‚ä½•å†™å‡ºå¯æµ‹è¯•æ€§å¥½çš„ä»£ç ï¼Ÿ</h1>
<p>åœ¨ä¸Šä¸€èŠ‚è¯¾ä¸­ï¼Œæˆ‘ä»¬å¯¹å•å…ƒæµ‹è¯•åšäº†ä»‹ç»ï¼Œè®²äº†â€œä»€ä¹ˆæ˜¯å•å…ƒæµ‹è¯•ï¼Ÿä¸ºä»€ä¹ˆè¦ç¼–å†™å•å…ƒæµ‹è¯•ï¼Ÿå¦‚ä½•ç¼–å†™å•å…ƒæµ‹è¯•ï¼Ÿå®è·µä¸­å•å…ƒæµ‹è¯•ä¸ºä»€ä¹ˆéš¾è´¯å½»æ‰§è¡Œï¼Ÿâ€è¿™æ ·å‡ ä¸ªé—®é¢˜ã€‚</p><p>å®é™…ä¸Šï¼Œå†™å•å…ƒæµ‹è¯•å¹¶ä¸éš¾ï¼Œä¹Ÿä¸éœ€è¦å¤ªå¤šæŠ€å·§ï¼Œç›¸åï¼Œå†™å‡ºå¯æµ‹è¯•çš„ä»£ç åå€’æ˜¯ä»¶éå¸¸æœ‰æŒ‘æˆ˜çš„äº‹æƒ…ã€‚æ‰€ä»¥ï¼Œä»Šå¤©ï¼Œæˆ‘ä»¬å°±å†æ¥èŠä¸€èŠä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œä¸»è¦åŒ…æ‹¬è¿™æ ·å‡ ä¸ªé—®é¢˜ï¼š</p><ul>
<li>ä»€ä¹ˆæ˜¯ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Ÿ</li>
<li>å¦‚ä½•å†™å‡ºå¯æµ‹è¯•çš„ä»£ç ï¼Ÿ</li>
<li>æœ‰å“ªäº›å¸¸è§çš„ä¸å¥½æµ‹è¯•çš„ä»£ç ï¼Ÿ</li>
</ul><p>è¯ä¸å¤šè¯´ï¼Œè®©æˆ‘ä»¬æ­£å¼å¼€å§‹ä»Šå¤©çš„å­¦ä¹ å§ï¼</p><h2>ç¼–å†™å¯æµ‹è¯•ä»£ç æ¡ˆä¾‹å®æˆ˜</h2><p>åˆšåˆšæåˆ°çš„è¿™å‡ ä¸ªå…³äºä»£ç å¯æµ‹è¯•æ€§çš„é—®é¢˜ï¼Œæˆ‘å‡†å¤‡é€šè¿‡ä¸€ä¸ªå®æˆ˜æ¡ˆä¾‹æ¥è®²è§£ã€‚å…·ä½“çš„è¢«æµ‹è¯•ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><p>å…¶ä¸­ï¼ŒTransactionæ˜¯ç»è¿‡æˆ‘æŠ½è±¡ç®€åŒ–ä¹‹åçš„ä¸€ä¸ªç”µå•†ç³»ç»Ÿçš„äº¤æ˜“ç±»ï¼Œç”¨æ¥è®°å½•æ¯ç¬”è®¢å•äº¤æ˜“çš„æƒ…å†µã€‚Transactionç±»ä¸­çš„execute()å‡½æ•°è´Ÿè´£æ‰§è¡Œè½¬è´¦æ“ä½œï¼Œå°†é’±ä»ä¹°å®¶çš„é’±åŒ…è½¬åˆ°å–å®¶çš„é’±åŒ…ä¸­ã€‚çœŸæ­£çš„è½¬è´¦æ“ä½œæ˜¯é€šè¿‡è°ƒç”¨WalletRpcService RPCæœåŠ¡æ¥å®Œæˆçš„ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œä»£ç ä¸­è¿˜æ¶‰åŠä¸€ä¸ªåˆ†å¸ƒå¼é”DistributedLockå•ä¾‹ç±»ï¼Œç”¨æ¥é¿å…Transactionå¹¶å‘æ‰§è¡Œï¼Œå¯¼è‡´ç”¨æˆ·çš„é’±è¢«é‡å¤è½¬å‡ºã€‚</p><pre><code>public class Transaction {
  private String id;
  private Long buyerId;
  private Long sellerId;
  private Long productId;
  private String orderId;
  private Long createTimestamp;
  private Double amount;
  private STATUS status;
  private String walletTransactionId;
  
  // ...get() methods...
  
  public Transaction(String preAssignedId, Long buyerId, Long sellerId, Long productId, String orderId) {
    if (preAssignedId != null &amp;&amp; !preAssignedId.isEmpty()) {
      this.id = preAssignedId;
    } else {
      this.id = IdGenerator.generateTransactionId();
    }
    if (!this.id.startWith(&quot;t_&quot;)) {
      this.id = &quot;t_&quot; + preAssignedId;
    }
    this.buyerId = buyerId;
    this.sellerId = sellerId;
    this.productId = productId;
    this.orderId = orderId;
    this.status = STATUS.TO_BE_EXECUTD;
    this.createTimestamp = System.currentTimestamp();
  }
  
  public boolean execute() throws InvalidTransactionException {
    if ((buyerId == null || (sellerId == null || amount &lt; 0.0) {
      throw new InvalidTransactionException(...);
    }
    if (status == STATUS.EXECUTED) return true;
    boolean isLocked = false;
    try {
      isLocked = RedisDistributedLock.getSingletonIntance().lockTransction(id);
      if (!isLocked) {
        return false; // é”å®šæœªæˆåŠŸï¼Œè¿”å›falseï¼Œjobå…œåº•æ‰§è¡Œ
      }
      if (status == STATUS.EXECUTED) return true; // double check
      long executionInvokedTimestamp = System.currentTimestamp();
      if (executionInvokedTimestamp - createdTimestap &gt; 14days) {
        this.status = STATUS.EXPIRED;
        return false;
      }
      WalletRpcService walletRpcService = new WalletRpcService();
      String walletTransactionId = walletRpcService.moveMoney(id, buyerId, sellerId, amount);
      if (walletTransactionId != null) {
        this.walletTransactionId = walletTransactionId;
        this.status = STATUS.EXECUTED;
        return true;
      } else {
        this.status = STATUS.FAILED;
        return false;
      }
    } finally {
      if (isLocked) {
       RedisDistributedLock.getSingletonIntance().unlockTransction(id);
      }
    }
  }
}
</code></pre><p>å¯¹æ¯”ä¸Šä¸€èŠ‚è¯¾ä¸­çš„Textç±»çš„ä»£ç ï¼Œè¿™æ®µä»£ç è¦å¤æ‚å¾ˆå¤šã€‚å¦‚æœè®©ä½ ç»™è¿™æ®µä»£ç ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œä½ ä¼šå¦‚ä½•æ¥å†™å‘¢ï¼Ÿä½ å¯ä»¥å…ˆè¯•ç€æ€è€ƒä¸€ä¸‹ï¼Œç„¶åå†æ¥çœ‹æˆ‘ä¸‹é¢çš„åˆ†æã€‚</p><!-- [[[read_end]]] --><p>åœ¨Transactionç±»ä¸­ï¼Œä¸»è¦é€»è¾‘é›†ä¸­åœ¨execute()å‡½æ•°ä¸­ï¼Œæ‰€ä»¥å®ƒæ˜¯æˆ‘ä»¬æµ‹è¯•çš„é‡ç‚¹å¯¹è±¡ã€‚ä¸ºäº†å°½å¯èƒ½å…¨é¢è¦†ç›–å„ç§æ­£å¸¸å’Œå¼‚å¸¸æƒ…å†µï¼Œé’ˆå¯¹è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘è®¾è®¡äº†ä¸‹é¢6ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚</p><ol>
<li>æ­£å¸¸æƒ…å†µä¸‹ï¼Œäº¤æ˜“æ‰§è¡ŒæˆåŠŸï¼Œå›å¡«ç”¨äºå¯¹è´¦ï¼ˆäº¤æ˜“ä¸é’±åŒ…çš„äº¤æ˜“æµæ°´ï¼‰ç”¨çš„walletTransactionIdï¼Œäº¤æ˜“çŠ¶æ€è®¾ç½®ä¸ºEXECUTEDï¼Œå‡½æ•°è¿”å›trueã€‚</li>
<li>buyerIdã€sellerIdä¸ºnullã€amountå°äº0ï¼Œè¿”å›InvalidTransactionExceptionã€‚</li>
<li>äº¤æ˜“å·²è¿‡æœŸï¼ˆcreateTimestampè¶…è¿‡14å¤©ï¼‰ï¼Œäº¤æ˜“çŠ¶æ€è®¾ç½®ä¸ºEXPIREDï¼Œè¿”å›falseã€‚</li>
<li>äº¤æ˜“å·²ç»æ‰§è¡Œäº†ï¼ˆstatus==EXECUTEDï¼‰ï¼Œä¸å†é‡å¤æ‰§è¡Œè½¬é’±é€»è¾‘ï¼Œè¿”å›trueã€‚</li>
<li>é’±åŒ…ï¼ˆWalletRpcServiceï¼‰è½¬é’±å¤±è´¥ï¼Œäº¤æ˜“çŠ¶æ€è®¾ç½®ä¸ºFAILEDï¼Œå‡½æ•°è¿”å›falseã€‚</li>
<li>äº¤æ˜“æ­£åœ¨æ‰§è¡Œç€ï¼Œä¸ä¼šè¢«é‡å¤æ‰§è¡Œï¼Œå‡½æ•°ç›´æ¥è¿”å›falseã€‚</li>
</ol><p>æµ‹è¯•ç”¨ä¾‹è®¾è®¡å®Œäº†ã€‚ç°åœ¨çœ‹èµ·æ¥ä¼¼ä¹ä¸€åˆ‡è¿›å±•é¡ºåˆ©ã€‚ä½†æ˜¯ï¼Œäº‹å®æ˜¯ï¼Œå½“æˆ‘ä»¬å°†æµ‹è¯•ç”¨ä¾‹è½å®åˆ°å…·ä½“çš„ä»£ç å®ç°æ—¶ï¼Œä½ å°±ä¼šå‘ç°æœ‰å¾ˆå¤šè¡Œä¸é€šçš„åœ°æ–¹ã€‚å¯¹äºä¸Šé¢çš„æµ‹è¯•ç”¨ä¾‹ï¼Œç¬¬2ä¸ªå®ç°èµ·æ¥éå¸¸ç®€å•ï¼Œæˆ‘å°±ä¸åšä»‹ç»äº†ã€‚æˆ‘ä»¬é‡ç‚¹æ¥çœ‹å…¶ä¸­çš„1å’Œ3ã€‚æµ‹è¯•ç”¨ä¾‹4ã€5ã€6è·Ÿ3ç±»ä¼¼ï¼Œç•™ç»™ä½ è‡ªå·±æ¥å®ç°ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å°±æ¥çœ‹æµ‹è¯•ç”¨ä¾‹1çš„ä»£ç å®ç°ã€‚å…·ä½“å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>public void testExecute() {
  Long buyerId = 123L;
  Long sellerId = 234L;
  Long productId = 345L;
  Long orderId = 456L;
  Transction transaction = new Transaction(null, buyerId, sellerId, productId, orderId);
  boolean executedResult = transaction.execute();
  assertTrue(executedResult);
}
</code></pre><p>execute()å‡½æ•°çš„æ‰§è¡Œä¾èµ–ä¸¤ä¸ªå¤–éƒ¨çš„æœåŠ¡ï¼Œä¸€ä¸ªæ˜¯RedisDistributedLockï¼Œä¸€ä¸ªWalletRpcServiceã€‚è¿™å°±å¯¼è‡´ä¸Šé¢çš„å•å…ƒæµ‹è¯•ä»£ç å­˜åœ¨ä¸‹é¢å‡ ä¸ªé—®é¢˜ã€‚</p><ul>
<li>å¦‚æœè¦è®©è¿™ä¸ªå•å…ƒæµ‹è¯•èƒ½å¤Ÿè¿è¡Œï¼Œæˆ‘ä»¬éœ€è¦æ­å»ºRedisæœåŠ¡å’ŒWallet RPCæœåŠ¡ã€‚æ­å»ºå’Œç»´æŠ¤çš„æˆæœ¬æ¯”è¾ƒé«˜ã€‚</li>
<li>æˆ‘ä»¬è¿˜éœ€è¦ä¿è¯å°†ä¼ªé€ çš„transactionæ•°æ®å‘é€ç»™Wallet RPCæœåŠ¡ä¹‹åï¼Œèƒ½å¤Ÿæ­£ç¡®è¿”å›æˆ‘ä»¬æœŸæœ›çš„ç»“æœï¼Œç„¶è€ŒWallet RPCæœåŠ¡æœ‰å¯èƒ½æ˜¯ç¬¬ä¸‰æ–¹ï¼ˆå¦ä¸€ä¸ªå›¢é˜Ÿå¼€å‘ç»´æŠ¤çš„ï¼‰çš„æœåŠ¡ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬å¯æ§çš„ã€‚æ¢å¥è¯è¯´ï¼Œå¹¶ä¸æ˜¯æˆ‘ä»¬æƒ³è®©å®ƒè¿”å›ä»€ä¹ˆæ•°æ®å°±è¿”å›ä»€ä¹ˆã€‚</li>
<li>Transactionçš„æ‰§è¡Œè·ŸRedisã€RPCæœåŠ¡é€šä¿¡ï¼Œéœ€è¦èµ°ç½‘ç»œï¼Œè€—æ—¶å¯èƒ½ä¼šæ¯”è¾ƒé•¿ï¼Œå¯¹å•å…ƒæµ‹è¯•æœ¬èº«çš„æ‰§è¡Œæ€§èƒ½ä¹Ÿä¼šæœ‰å½±å“ã€‚</li>
<li>ç½‘ç»œçš„ä¸­æ–­ã€è¶…æ—¶ã€Redisã€RPCæœåŠ¡çš„ä¸å¯ç”¨ï¼Œéƒ½ä¼šå½±å“å•å…ƒæµ‹è¯•çš„æ‰§è¡Œã€‚</li>
</ul><p>æˆ‘ä»¬å›åˆ°å•å…ƒæµ‹è¯•çš„å®šä¹‰ä¸Šæ¥çœ‹ä¸€ä¸‹ã€‚å•å…ƒæµ‹è¯•ä¸»è¦æ˜¯æµ‹è¯•ç¨‹åºå‘˜è‡ªå·±ç¼–å†™çš„ä»£ç é€»è¾‘çš„æ­£ç¡®æ€§ï¼Œå¹¶éæ˜¯ç«¯åˆ°ç«¯çš„é›†æˆæµ‹è¯•ï¼Œå®ƒä¸éœ€è¦æµ‹è¯•æ‰€ä¾èµ–çš„å¤–éƒ¨ç³»ç»Ÿï¼ˆåˆ†å¸ƒå¼é”ã€Wallet RPCæœåŠ¡ï¼‰çš„é€»è¾‘æ­£ç¡®æ€§ã€‚æ‰€ä»¥ï¼Œå¦‚æœä»£ç ä¸­ä¾èµ–äº†å¤–éƒ¨ç³»ç»Ÿæˆ–è€…ä¸å¯æ§ç»„ä»¶ï¼Œæ¯”å¦‚ï¼Œéœ€è¦ä¾èµ–æ•°æ®åº“ã€ç½‘ç»œé€šä¿¡ã€æ–‡ä»¶ç³»ç»Ÿç­‰ï¼Œé‚£æˆ‘ä»¬å°±éœ€è¦å°†è¢«æµ‹ä»£ç ä¸å¤–éƒ¨ç³»ç»Ÿè§£ä¾èµ–ï¼Œè€Œè¿™ç§è§£ä¾èµ–çš„æ–¹æ³•å°±å«ä½œâ€œmockâ€ã€‚æ‰€è°“çš„mockå°±æ˜¯ç”¨ä¸€ä¸ªâ€œå‡â€çš„æœåŠ¡æ›¿æ¢çœŸæ­£çš„æœåŠ¡ã€‚mockçš„æœåŠ¡å®Œå…¨åœ¨æˆ‘ä»¬çš„æ§åˆ¶ä¹‹ä¸‹ï¼Œæ¨¡æ‹Ÿè¾“å‡ºæˆ‘ä»¬æƒ³è¦çš„æ•°æ®ã€‚</p><p>é‚£å¦‚ä½•æ¥mockæœåŠ¡å‘¢ï¼Ÿmockçš„æ–¹å¼ä¸»è¦æœ‰ä¸¤ç§ï¼Œæ‰‹åŠ¨mockå’Œåˆ©ç”¨æ¡†æ¶mockã€‚åˆ©ç”¨æ¡†æ¶mockä»…ä»…æ˜¯ä¸ºäº†ç®€åŒ–ä»£ç ç¼–å†™ï¼Œæ¯ä¸ªæ¡†æ¶çš„mockæ–¹å¼éƒ½ä¸å¤§ä¸€æ ·ã€‚æˆ‘ä»¬è¿™é‡Œåªå±•ç¤ºæ‰‹åŠ¨mockã€‚</p><p>æˆ‘ä»¬é€šè¿‡ç»§æ‰¿WalletRpcServiceç±»ï¼Œå¹¶ä¸”é‡å†™å…¶ä¸­çš„moveMoney()å‡½æ•°çš„æ–¹å¼æ¥å®ç°mockã€‚å…·ä½“çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºã€‚é€šè¿‡mockçš„æ–¹å¼ï¼Œæˆ‘ä»¬å¯ä»¥è®©moveMoney()è¿”å›ä»»æ„æˆ‘ä»¬æƒ³è¦çš„æ•°æ®ï¼Œå®Œå…¨åœ¨æˆ‘ä»¬çš„æ§åˆ¶èŒƒå›´å†…ï¼Œå¹¶ä¸”ä¸éœ€è¦çœŸæ­£è¿›è¡Œç½‘ç»œé€šä¿¡ã€‚</p><pre><code>public class MockWalletRpcServiceOne extends WalletRpcService {
  public String moveMoney(Long id, Long fromUserId, Long toUserId, Double amount) {
    return &quot;123bac&quot;;
  } 
}

public class MockWalletRpcServiceTwo extends WalletRpcService {
  public String moveMoney(Long id, Long fromUserId, Long toUserId, Double amount) {
    return null;
  } 
}
</code></pre><p>ç°åœ¨æˆ‘ä»¬å†æ¥çœ‹ï¼Œå¦‚ä½•ç”¨MockWalletRpcServiceOneã€MockWalletRpcServiceTwoæ¥æ›¿æ¢ä»£ç ä¸­çš„çœŸæ­£çš„WalletRpcServiceå‘¢ï¼Ÿ</p><p>å› ä¸ºWalletRpcServiceæ˜¯åœ¨execute()å‡½æ•°ä¸­é€šè¿‡newçš„æ–¹å¼åˆ›å»ºçš„ï¼Œæˆ‘ä»¬æ— æ³•åŠ¨æ€åœ°å¯¹å…¶è¿›è¡Œæ›¿æ¢ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒTransactionç±»ä¸­çš„execute()æ–¹æ³•çš„å¯æµ‹è¯•æ€§å¾ˆå·®ï¼Œéœ€è¦é€šè¿‡é‡æ„æ¥è®©å…¶å˜å¾—æ›´å®¹æ˜“æµ‹è¯•ã€‚è¯¥å¦‚ä½•é‡æ„è¿™æ®µä»£ç å‘¢ï¼Ÿ</p><p>åœ¨<a href="https://time.geekbang.org/column/article/177444">ç¬¬19èŠ‚</a>ä¸­ï¼Œæˆ‘ä»¬è®²åˆ°ï¼Œä¾èµ–æ³¨å…¥æ˜¯å®ç°ä»£ç å¯æµ‹è¯•æ€§çš„æœ€æœ‰æ•ˆçš„æ‰‹æ®µã€‚æˆ‘ä»¬å¯ä»¥åº”ç”¨ä¾èµ–æ³¨å…¥ï¼Œå°†WalletRpcServiceå¯¹è±¡çš„åˆ›å»ºåè½¬ç»™ä¸Šå±‚é€»è¾‘ï¼Œåœ¨å¤–éƒ¨åˆ›å»ºå¥½ä¹‹åï¼Œå†æ³¨å…¥åˆ°Transactionç±»ä¸­ã€‚é‡æ„ä¹‹åçš„Transactionç±»çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>public class Transaction {
  //...
  // æ·»åŠ ä¸€ä¸ªæˆå‘˜å˜é‡åŠå…¶setæ–¹æ³•
  private WalletRpcService walletRpcService;
  
  public void setWalletRpcService(WalletRpcService walletRpcService) {
    this.walletRpcService = walletRpcService;
  }
  // ...
  public boolean execute() {
    // ...
    // åˆ é™¤ä¸‹é¢è¿™ä¸€è¡Œä»£ç 
    // WalletRpcService walletRpcService = new WalletRpcService();
    // ...
  }
}
</code></pre><p>ç°åœ¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥åœ¨å•å…ƒæµ‹è¯•ä¸­ï¼Œéå¸¸å®¹æ˜“åœ°å°†WalletRpcServiceæ›¿æ¢æˆMockWalletRpcServiceOneæˆ–WalletRpcServiceTwoäº†ã€‚é‡æ„ä¹‹åçš„ä»£ç å¯¹åº”çš„å•å…ƒæµ‹è¯•å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>public void testExecute() {
  Long buyerId = 123L;
  Long sellerId = 234L;
  Long productId = 345L;
  Long orderId = 456L;
  Transction transaction = new Transaction(null, buyerId, sellerId, productId, orderId);
  // ä½¿ç”¨mockå¯¹è±¡æ¥æ›¿ä»£çœŸæ­£çš„RPCæœåŠ¡
  transaction.setWalletRpcService(new MockWalletRpcServiceOne()):
  boolean executedResult = transaction.execute();
  assertTrue(executedResult);
  assertEquals(STATUS.EXECUTED, transaction.getStatus());
}
</code></pre><p>WalletRpcServiceçš„mockå’Œæ›¿æ¢é—®é¢˜è§£å†³äº†ï¼Œæˆ‘ä»¬å†æ¥çœ‹RedisDistributedLockã€‚å®ƒçš„mockå’Œæ›¿æ¢è¦å¤æ‚ä¸€äº›ï¼Œä¸»è¦æ˜¯å› ä¸ºRedisDistributedLockæ˜¯ä¸€ä¸ªå•ä¾‹ç±»ã€‚å•ä¾‹ç›¸å½“äºä¸€ä¸ªå…¨å±€å˜é‡ï¼Œæˆ‘ä»¬æ— æ³•mockï¼ˆæ— æ³•ç»§æ‰¿å’Œé‡å†™æ–¹æ³•ï¼‰ï¼Œä¹Ÿæ— æ³•é€šè¿‡ä¾èµ–æ³¨å…¥çš„æ–¹å¼æ¥æ›¿æ¢ã€‚</p><p>å¦‚æœRedisDistributedLockæ˜¯æˆ‘ä»¬è‡ªå·±ç»´æŠ¤çš„ï¼Œå¯ä»¥è‡ªç”±ä¿®æ”¹ã€é‡æ„ï¼Œé‚£æˆ‘ä»¬å¯ä»¥å°†å…¶æ”¹ä¸ºéå•ä¾‹çš„æ¨¡å¼ï¼Œæˆ–è€…å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œæ¯”å¦‚IDistributedLockï¼Œè®©RedisDistributedLockå®ç°è¿™ä¸ªæ¥å£ã€‚è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥åƒå‰é¢WalletRpcServiceçš„æ›¿æ¢æ–¹å¼é‚£æ ·ï¼Œæ›¿æ¢RedisDistributedLockä¸ºMockRedisDistributedLockäº†ã€‚ä½†å¦‚æœRedisDistributedLockä¸æ˜¯æˆ‘ä»¬ç»´æŠ¤çš„ï¼Œæˆ‘ä»¬æ— æƒå»ä¿®æ”¹è¿™éƒ¨åˆ†ä»£ç ï¼Œè¿™ä¸ªæ—¶å€™è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ</p><p>æˆ‘ä»¬å¯ä»¥å¯¹transactionä¸Šé”è¿™éƒ¨åˆ†é€»è¾‘é‡æ–°å°è£…ä¸€ä¸‹ã€‚å…·ä½“ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>public class TransactionLock {
  public boolean lock(String id) {
    return RedisDistributedLock.getSingletonIntance().lockTransction(id);
  }
  
  public void unlock() {
    RedisDistributedLock.getSingletonIntance().unlockTransction(id);
  }
}

public class Transaction {
  //...
  private TransactionLock lock;
  
  public void setTransactionLock(TransactionLock lock) {
    this.lock = lock;
  }
 
  public boolean execute() {
    //...
    try {
      isLocked = lock.lock();
      //...
    } finally {
      if (isLocked) {
        lock.unlock();
      }
    }
    //...
  }
}
</code></pre><p>é’ˆå¯¹é‡æ„è¿‡çš„ä»£ç ï¼Œæˆ‘ä»¬çš„å•å…ƒæµ‹è¯•ä»£ç ä¿®æ”¹ä¸ºä¸‹é¢è¿™ä¸ªæ ·å­ã€‚è¿™æ ·ï¼Œæˆ‘ä»¬å°±èƒ½åœ¨å•å…ƒæµ‹è¯•ä»£ç ä¸­éš”ç¦»çœŸæ­£çš„RedisDistributedLockåˆ†å¸ƒå¼é”è¿™éƒ¨åˆ†é€»è¾‘äº†ã€‚</p><pre><code>public void testExecute() {
  Long buyerId = 123L;
  Long sellerId = 234L;
  Long productId = 345L;
  Long orderId = 456L;
  
  TransactionLock mockLock = new TransactionLock() {
    public boolean lock(String id) {
      return true;
    }
  
    public void unlock() {}
  };
  
  Transction transaction = new Transaction(null, buyerId, sellerId, productId, orderId);
  transaction.setWalletRpcService(new MockWalletRpcServiceOne());
  transaction.setTransactionLock(mockLock);
  boolean executedResult = transaction.execute();
  assertTrue(executedResult);
  assertEquals(STATUS.EXECUTED, transaction.getStatus());
}
</code></pre><p>è‡³æ­¤ï¼Œæµ‹è¯•ç”¨ä¾‹1å°±ç®—å†™å¥½äº†ã€‚æˆ‘ä»¬é€šè¿‡ä¾èµ–æ³¨å…¥å’Œmockï¼Œè®©å•å…ƒæµ‹è¯•ä»£ç ä¸ä¾èµ–ä»»ä½•ä¸å¯æ§çš„å¤–éƒ¨æœåŠ¡ã€‚ä½ å¯ä»¥ç…§ç€è¿™ä¸ªæ€è·¯ï¼Œè‡ªå·±å†™ä¸€ä¸‹æµ‹è¯•ç”¨ä¾‹4ã€5ã€6ã€‚</p><p>ç°åœ¨ï¼Œæˆ‘ä»¬å†æ¥çœ‹æµ‹è¯•ç”¨ä¾‹3ï¼šäº¤æ˜“å·²è¿‡æœŸï¼ˆcreateTimestampè¶…è¿‡14å¤©ï¼‰ï¼Œäº¤æ˜“çŠ¶æ€è®¾ç½®ä¸ºEXPIREDï¼Œè¿”å›falseã€‚é’ˆå¯¹è¿™ä¸ªå•å…ƒæµ‹è¯•ç”¨ä¾‹ï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆæŠŠä»£ç å†™å‡ºæ¥ï¼Œç„¶åå†æ¥åˆ†æã€‚</p><pre><code>public void testExecute_with_TransactionIsExpired() {
  Long buyerId = 123L;
  Long sellerId = 234L;
  Long productId = 345L;
  Long orderId = 456L;
  Transction transaction = new Transaction(null, buyerId, sellerId, productId, orderId);
  transaction.setCreatedTimestamp(System.currentTimestamp() - 14days);
  boolean actualResult = transaction.execute();
  assertFalse(actualResult);
  assertEquals(STATUS.EXPIRED, transaction.getStatus());
}
</code></pre><p>ä¸Šé¢çš„ä»£ç çœ‹ä¼¼æ²¡æœ‰ä»»ä½•é—®é¢˜ã€‚æˆ‘ä»¬å°†transactionçš„åˆ›å»ºæ—¶é—´createdTimestampè®¾ç½®ä¸º14å¤©å‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“å•å…ƒæµ‹è¯•ä»£ç è¿è¡Œçš„æ—¶å€™ï¼Œtransactionä¸€å®šæ˜¯å¤„äºè¿‡æœŸçŠ¶æ€ã€‚ä½†æ˜¯ï¼Œå¦‚æœåœ¨Transactionç±»ä¸­ï¼Œå¹¶æ²¡æœ‰æš´éœ²ä¿®æ”¹createdTimestampæˆå‘˜å˜é‡çš„setæ–¹æ³•ï¼ˆä¹Ÿå°±æ˜¯æ²¡æœ‰å®šä¹‰setCreatedTimestamp()å‡½æ•°ï¼‰å‘¢ï¼Ÿ</p><p>ä½ å¯èƒ½ä¼šè¯´ï¼Œå¦‚æœæ²¡æœ‰createTimestampçš„setæ–¹æ³•ï¼Œæˆ‘å°±é‡æ–°æ·»åŠ ä¸€ä¸ªå‘—ï¼å®é™…ä¸Šï¼Œè¿™è¿åäº†ç±»çš„å°è£…ç‰¹æ€§ã€‚åœ¨Transactionç±»çš„è®¾è®¡ä¸­ï¼ŒcreateTimestampæ˜¯åœ¨äº¤æ˜“ç”Ÿæˆæ—¶ï¼ˆä¹Ÿå°±æ˜¯æ„é€ å‡½æ•°ä¸­ï¼‰è‡ªåŠ¨è·å–çš„ç³»ç»Ÿæ—¶é—´ï¼Œæœ¬æ¥å°±ä¸åº”è¯¥äººä¸ºåœ°è½»æ˜“ä¿®æ”¹ï¼Œæ‰€ä»¥ï¼Œæš´éœ²createTimestampçš„setæ–¹æ³•ï¼Œè™½ç„¶å¸¦æ¥äº†çµæ´»æ€§ï¼Œä½†ä¹Ÿå¸¦æ¥äº†ä¸å¯æ§æ€§ã€‚å› ä¸ºï¼Œæˆ‘ä»¬æ— æ³•æ§åˆ¶ä½¿ç”¨è€…æ˜¯å¦ä¼šè°ƒç”¨setæ–¹æ³•é‡è®¾createTimestampï¼Œè€Œé‡è®¾createTimestampå¹¶éæˆ‘ä»¬çš„é¢„æœŸè¡Œä¸ºã€‚</p><p>é‚£å¦‚æœæ²¡æœ‰é’ˆå¯¹createTimestampçš„setæ–¹æ³•ï¼Œé‚£æµ‹è¯•ç”¨ä¾‹3åˆè¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿå®é™…ä¸Šï¼Œè¿™æ˜¯ä¸€ç±»æ¯”è¾ƒå¸¸è§çš„é—®é¢˜ï¼Œå°±æ˜¯ä»£ç ä¸­åŒ…å«è·Ÿâ€œæ—¶é—´â€æœ‰å…³çš„â€œæœªå†³è¡Œä¸ºâ€é€»è¾‘ã€‚æˆ‘ä»¬ä¸€èˆ¬çš„å¤„ç†æ–¹å¼æ˜¯å°†è¿™ç§æœªå†³è¡Œä¸ºé€»è¾‘é‡æ–°å°è£…ã€‚é’ˆå¯¹Transactionç±»ï¼Œæˆ‘ä»¬åªéœ€è¦å°†äº¤æ˜“æ˜¯å¦è¿‡æœŸçš„é€»è¾‘ï¼Œå°è£…åˆ°isExpired()å‡½æ•°ä¸­å³å¯ï¼Œå…·ä½“çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>public class Transaction {

  protected boolean isExpired() {
    long executionInvokedTimestamp = System.currentTimestamp();
    return executionInvokedTimestamp - createdTimestamp &gt; 14days;
  }
  
  public boolean execute() throws InvalidTransactionException {
    //...
      if (isExpired()) {
        this.status = STATUS.EXPIRED;
        return false;
      }
    //...
  }
}
</code></pre><p>é’ˆå¯¹é‡æ„ä¹‹åçš„ä»£ç ï¼Œæµ‹è¯•ç”¨ä¾‹3çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>public void testExecute_with_TransactionIsExpired() {
  Long buyerId = 123L;
  Long sellerId = 234L;
  Long productId = 345L;
  Long orderId = 456L;
  Transction transaction = new Transaction(null, buyerId, sellerId, productId, orderId) {
    protected boolean isExpired() {
      return true;
    }
  };
  boolean actualResult = transaction.execute();
  assertFalse(actualResult);
  assertEquals(STATUS.EXPIRED, transaction.getStatus());
}
</code></pre><p>é€šè¿‡é‡æ„ï¼ŒTransactionä»£ç çš„å¯æµ‹è¯•æ€§æé«˜äº†ã€‚ä¹‹å‰ç½—åˆ—çš„æ‰€æœ‰æµ‹è¯•ç”¨ä¾‹ï¼Œç°åœ¨æˆ‘ä»¬éƒ½é¡ºåˆ©å®ç°äº†ã€‚ä¸è¿‡ï¼ŒTransactionç±»çš„æ„é€ å‡½æ•°çš„è®¾è®¡è¿˜æœ‰ç‚¹ä¸å¦¥ã€‚ä¸ºäº†æ–¹ä¾¿ä½ æŸ¥çœ‹ï¼Œæˆ‘æŠŠæ„é€ å‡½æ•°çš„ä»£ç é‡æ–°copyäº†ä¸€ä»½è´´åˆ°è¿™é‡Œã€‚</p><pre><code>  public Transaction(String preAssignedId, Long buyerId, Long sellerId, Long productId, String orderId) {
    if (preAssignedId != null &amp;&amp; !preAssignedId.isEmpty()) {
      this.id = preAssignedId;
    } else {
      this.id = IdGenerator.generateTransactionId();
    }
    if (!this.id.startWith(&quot;t_&quot;)) {
      this.id = &quot;t_&quot; + preAssignedId;
    }
    this.buyerId = buyerId;
    this.sellerId = sellerId;
    this.productId = productId;
    this.orderId = orderId;
    this.status = STATUS.TO_BE_EXECUTD;
    this.createTimestamp = System.currentTimestamp();
  }
</code></pre><p>æˆ‘ä»¬å‘ç°ï¼Œæ„é€ å‡½æ•°ä¸­å¹¶éåªåŒ…å«ç®€å•èµ‹å€¼æ“ä½œã€‚äº¤æ˜“idçš„èµ‹å€¼é€»è¾‘ç¨å¾®å¤æ‚ã€‚æˆ‘ä»¬æœ€å¥½ä¹Ÿè¦æµ‹è¯•ä¸€ä¸‹ï¼Œä»¥ä¿è¯è¿™éƒ¨åˆ†é€»è¾‘çš„æ­£ç¡®æ€§ã€‚ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠidèµ‹å€¼è¿™éƒ¨åˆ†é€»è¾‘å•ç‹¬æŠ½è±¡åˆ°ä¸€ä¸ªå‡½æ•°ä¸­ï¼Œå…·ä½“çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºï¼š</p><pre><code>  public Transaction(String preAssignedId, Long buyerId, Long sellerId, Long productId, String orderId) {
    //...
    fillTransactionId(preAssignId);
    //...
  }
  
  protected void fillTransactionId(String preAssignedId) {
    if (preAssignedId != null &amp;&amp; !preAssignedId.isEmpty()) {
      this.id = preAssignedId;
    } else {
      this.id = IdGenerator.generateTransactionId();
    }
    if (!this.id.startWith(&quot;t_&quot;)) {
      this.id = &quot;t_&quot; + preAssignedId;
    }
  }
</code></pre><p>åˆ°æ­¤ä¸ºæ­¢ï¼Œæˆ‘ä»¬ä¸€æ­¥ä¸€æ­¥å°†Transactionä»ä¸å¯æµ‹è¯•ä»£ç é‡æ„æˆäº†æµ‹è¯•æ€§è‰¯å¥½çš„ä»£ç ã€‚ä¸è¿‡ï¼Œä½ å¯èƒ½è¿˜ä¼šæœ‰ç–‘é—®ï¼ŒTransactionç±»ä¸­isExpired()å‡½æ•°å°±ä¸ç”¨æµ‹è¯•äº†å—ï¼Ÿå¯¹äºisExpired()å‡½æ•°ï¼Œé€»è¾‘éå¸¸ç®€å•ï¼Œè‚‰çœ¼å°±èƒ½åˆ¤å®šæ˜¯å¦æœ‰bugï¼Œæ˜¯å¯ä»¥ä¸ç”¨å†™å•å…ƒæµ‹è¯•çš„ã€‚</p><p>å®é™…ä¸Šï¼Œå¯æµ‹è¯•æ€§å·®çš„ä»£ç ï¼Œæœ¬èº«ä»£ç è®¾è®¡å¾—ä¹Ÿä¸å¤Ÿå¥½ï¼Œå¾ˆå¤šåœ°æ–¹éƒ½æ²¡æœ‰éµå®ˆæˆ‘ä»¬ä¹‹å‰è®²åˆ°çš„è®¾è®¡åŸåˆ™å’Œæ€æƒ³ï¼Œæ¯”å¦‚â€œåŸºäºæ¥å£è€Œéå®ç°ç¼–ç¨‹â€æ€æƒ³ã€ä¾èµ–åè½¬åŸåˆ™ç­‰ã€‚é‡æ„ä¹‹åçš„ä»£ç ï¼Œä¸ä»…å¯æµ‹è¯•æ€§æ›´å¥½ï¼Œè€Œä¸”ä»ä»£ç è®¾è®¡çš„è§’åº¦æ¥è¯´ï¼Œä¹Ÿéµä»äº†ç»å…¸çš„è®¾è®¡åŸåˆ™å’Œæ€æƒ³ã€‚è¿™ä¹Ÿå°è¯äº†æˆ‘ä»¬ä¹‹å‰è¯´è¿‡çš„ï¼Œä»£ç çš„å¯æµ‹è¯•æ€§å¯ä»¥ä»ä¾§é¢ä¸Šååº”ä»£ç è®¾è®¡æ˜¯å¦åˆç†ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨å¹³æ—¶çš„å¼€å‘ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿè¦å¤šæ€è€ƒä¸€ä¸‹ï¼Œè¿™æ ·ç¼–å†™ä»£ç ï¼Œæ˜¯å¦å®¹æ˜“ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œè¿™ä¹Ÿæœ‰åˆ©äºæˆ‘ä»¬è®¾è®¡å‡ºå¥½çš„ä»£ç ã€‚</p><h2>å…¶ä»–å¸¸è§çš„Anti-Patterns</h2><p>åˆšåˆšæˆ‘ä»¬é€šè¿‡ä¸€ä¸ªå®æˆ˜æ¡ˆä¾‹ï¼Œè®²è§£äº†å¦‚ä½•åˆ©ç”¨ä¾èµ–æ³¨å…¥æ¥æé«˜ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œä»¥åŠç¼–å†™å•å…ƒæµ‹è¯•ä¸­æœ€å¤æ‚çš„ä¸€éƒ¨åˆ†å†…å®¹ï¼šå¦‚ä½•é€šè¿‡mockã€äºŒæ¬¡å°è£…ç­‰æ–¹å¼è§£ä¾èµ–å¤–éƒ¨æœåŠ¡ã€‚ç°åœ¨ï¼Œæˆ‘ä»¬å†æ¥æ€»ç»“ä¸€ä¸‹ï¼Œæœ‰å“ªäº›å…¸å‹çš„ã€å¸¸è§çš„æµ‹è¯•æ€§ä¸å¥½çš„ä»£ç ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„Anti-Patternsã€‚</p><h3>1.æœªå†³è¡Œä¸º</h3><p>æ‰€è°“çš„æœªå†³è¡Œä¸ºé€»è¾‘å°±æ˜¯ï¼Œä»£ç çš„è¾“å‡ºæ˜¯éšæœºæˆ–è€…è¯´ä¸ç¡®å®šçš„ï¼Œæ¯”å¦‚ï¼Œè·Ÿæ—¶é—´ã€éšæœºæ•°æœ‰å…³çš„ä»£ç ã€‚å¯¹äºè¿™ä¸€ç‚¹ï¼Œåœ¨åˆšåˆšçš„å®æˆ˜æ¡ˆä¾‹ä¸­æˆ‘ä»¬å·²ç»è®²åˆ°ï¼Œä½ å¯ä»¥åˆ©ç”¨åˆšæ‰è®²åˆ°çš„æ–¹æ³•ï¼Œè¯•ç€é‡æ„ä¸€ä¸‹ä¸‹é¢çš„ä»£ç ï¼Œå¹¶ä¸”ä¸ºå®ƒç¼–å†™å•å…ƒæµ‹è¯•ã€‚</p><pre><code>public class Demo {
  public long caculateDelayDays(Date dueTime) {
    long currentTimestamp = System.currentTimeMillis();
    if (dueTime.getTime() &gt;= currentTimestamp) {
      return 0;
    }
    long delayTime = currentTimestamp - dueTime.getTime();
    long delayDays = delayTime / 86400;
    return delayDays;
  }
}
</code></pre><h3>2.å…¨å±€å˜é‡</h3><p>å‰é¢æˆ‘ä»¬è®²è¿‡ï¼Œå…¨å±€å˜é‡æ˜¯ä¸€ç§é¢å‘è¿‡ç¨‹çš„ç¼–ç¨‹é£æ ¼ï¼Œæœ‰ç§ç§å¼Šç«¯ã€‚å®é™…ä¸Šï¼Œæ»¥ç”¨å…¨å±€å˜é‡ä¹Ÿè®©ç¼–å†™å•å…ƒæµ‹è¯•å˜å¾—å›°éš¾ã€‚æˆ‘ä¸¾ä¸ªä¾‹å­æ¥è§£é‡Šä¸€ä¸‹ã€‚</p><p>RangeLimiterè¡¨ç¤ºä¸€ä¸ª[-5, 5]çš„åŒºé—´ï¼Œpositionåˆå§‹åœ¨0ä½ç½®ï¼Œmove()å‡½æ•°è´Ÿè´£ç§»åŠ¨positionã€‚å…¶ä¸­ï¼Œpositionæ˜¯ä¸€ä¸ªé™æ€å…¨å±€å˜é‡ã€‚RangeLimiterTestç±»æ˜¯ä¸ºå…¶è®¾è®¡çš„å•å…ƒæµ‹è¯•ï¼Œä¸è¿‡ï¼Œè¿™é‡Œé¢å­˜åœ¨å¾ˆå¤§çš„é—®é¢˜ï¼Œä½ å¯ä»¥å…ˆè‡ªå·±åˆ†æä¸€ä¸‹ã€‚</p><pre><code>public class RangeLimiter {
  private static AtomicInteger position = new AtomicInteger(0);
  public static final int MAX_LIMIT = 5;
  public static final int MIN_LIMIT = -5;

  public boolean move(int delta) {
    int currentPos = position.addAndGet(delta);
    boolean betweenRange = (currentPos &lt;= MAX_LIMIT) &amp;&amp; (currentPos &gt;= MIN_LIMIT);
    return betweenRange;
  }
}

public class RangeLimiterTest {
  public void testMove_betweenRange() {
    RangeLimiter rangeLimiter = new RangeLimiter();
    assertTrue(rangeLimiter.move(1));
    assertTrue(rangeLimiter.move(3));
    assertTrue(rangeLimiter.move(-5));
  }

  public void testMove_exceedRange() {
    RangeLimiter rangeLimiter = new RangeLimiter();
    assertFalse(rangeLimiter.move(6));
  }
}
</code></pre><p>ä¸Šé¢çš„å•å…ƒæµ‹è¯•æœ‰å¯èƒ½ä¼šè¿è¡Œå¤±è´¥ã€‚å‡è®¾å•å…ƒæµ‹è¯•æ¡†æ¶é¡ºåºä¾æ¬¡æ‰§è¡ŒtestMove_betweenRange()å’ŒtestMove_exceedRange()ä¸¤ä¸ªæµ‹è¯•ç”¨ä¾‹ã€‚åœ¨ç¬¬ä¸€ä¸ªæµ‹è¯•ç”¨ä¾‹æ‰§è¡Œå®Œæˆä¹‹åï¼Œpositionçš„å€¼å˜æˆäº†-1ï¼›å†æ‰§è¡Œç¬¬äºŒä¸ªæµ‹è¯•ç”¨ä¾‹çš„æ—¶å€™ï¼Œpositionå˜æˆäº†5ï¼Œmove()å‡½æ•°è¿”å›trueï¼ŒassertFalseè¯­å¥åˆ¤å®šå¤±è´¥ã€‚æ‰€ä»¥ï¼Œç¬¬äºŒä¸ªæµ‹è¯•ç”¨ä¾‹è¿è¡Œå¤±è´¥ã€‚</p><p>å½“ç„¶ï¼Œå¦‚æœRangeLimiterç±»æœ‰æš´éœ²é‡è®¾ï¼ˆresetï¼‰positionå€¼çš„å‡½æ•°ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨æ¯æ¬¡æ‰§è¡Œå•å…ƒæµ‹è¯•ç”¨ä¾‹ä¹‹å‰ï¼ŒæŠŠpositioné‡è®¾ä¸º0ï¼Œè¿™æ ·å°±èƒ½è§£å†³åˆšåˆšçš„é—®é¢˜ã€‚</p><p>ä¸è¿‡ï¼Œæ¯ä¸ªå•å…ƒæµ‹è¯•æ¡†æ¶æ‰§è¡Œå•å…ƒæµ‹è¯•ç”¨ä¾‹çš„æ–¹å¼å¯èƒ½æ˜¯ä¸åŒçš„ã€‚æœ‰çš„æ˜¯é¡ºåºæ‰§è¡Œï¼Œæœ‰çš„æ˜¯å¹¶å‘æ‰§è¡Œã€‚å¯¹äºå¹¶å‘æ‰§è¡Œçš„æƒ…å†µï¼Œå³ä¾¿æˆ‘ä»¬æ¯æ¬¡éƒ½æŠŠpositioné‡è®¾ä¸º0ï¼Œä¹Ÿå¹¶ä¸å¥æ•ˆã€‚å¦‚æœä¸¤ä¸ªæµ‹è¯•ç”¨ä¾‹å¹¶å‘æ‰§è¡Œï¼Œç¬¬16ã€17ã€18ã€23è¿™å››è¡Œä»£ç å¯èƒ½ä¼šäº¤å‰æ‰§è¡Œï¼Œå½±å“åˆ°move()å‡½æ•°çš„æ‰§è¡Œç»“æœã€‚</p><h3>3.é™æ€æ–¹æ³•</h3><p>å‰é¢æˆ‘ä»¬ä¹Ÿæåˆ°ï¼Œé™æ€æ–¹æ³•è·Ÿå…¨å±€å˜é‡ä¸€æ ·ï¼Œä¹Ÿæ˜¯ä¸€ç§é¢å‘è¿‡ç¨‹çš„ç¼–ç¨‹æ€ç»´ã€‚åœ¨ä»£ç ä¸­è°ƒç”¨é™æ€æ–¹æ³•ï¼Œæœ‰æ—¶å€™ä¼šå¯¼è‡´ä»£ç ä¸æ˜“æµ‹è¯•ã€‚ä¸»è¦åŸå› æ˜¯é™æ€æ–¹æ³•ä¹Ÿå¾ˆéš¾mockã€‚ä½†æ˜¯ï¼Œè¿™ä¸ªè¦åˆ†æƒ…å†µæ¥çœ‹ã€‚åªæœ‰åœ¨è¿™ä¸ªé™æ€æ–¹æ³•æ‰§è¡Œè€—æ—¶å¤ªé•¿ã€ä¾èµ–å¤–éƒ¨èµ„æºã€é€»è¾‘å¤æ‚ã€è¡Œä¸ºæœªå†³ç­‰æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ‰éœ€è¦åœ¨å•å…ƒæµ‹è¯•ä¸­mockè¿™ä¸ªé™æ€æ–¹æ³•ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå¦‚æœåªæ˜¯ç±»ä¼¼Math.abs()è¿™æ ·çš„ç®€å•é™æ€æ–¹æ³•ï¼Œå¹¶ä¸ä¼šå½±å“ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œå› ä¸ºæœ¬èº«å¹¶ä¸éœ€è¦mockã€‚</p><h3>4.å¤æ‚ç»§æ‰¿</h3><p>æˆ‘ä»¬å‰é¢æåˆ°ï¼Œç›¸æ¯”ç»„åˆå…³ç³»ï¼Œç»§æ‰¿å…³ç³»çš„ä»£ç ç»“æ„æ›´åŠ è€¦åˆã€ä¸çµæ´»ï¼Œæ›´åŠ ä¸æ˜“æ‰©å±•ã€ä¸æ˜“ç»´æŠ¤ã€‚å®é™…ä¸Šï¼Œç»§æ‰¿å…³ç³»ä¹Ÿæ›´åŠ éš¾æµ‹è¯•ã€‚è¿™ä¹Ÿå°è¯äº†ä»£ç çš„å¯æµ‹è¯•æ€§è·Ÿä»£ç è´¨é‡çš„ç›¸å…³æ€§ã€‚</p><p>å¦‚æœçˆ¶ç±»éœ€è¦mockæŸä¸ªä¾èµ–å¯¹è±¡æ‰èƒ½è¿›è¡Œå•å…ƒæµ‹è¯•ï¼Œé‚£æ‰€æœ‰çš„å­ç±»ã€å­ç±»çš„å­ç±»â€¦â€¦åœ¨ç¼–å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œéƒ½è¦mockè¿™ä¸ªä¾èµ–å¯¹è±¡ã€‚å¯¹äºå±‚æ¬¡å¾ˆæ·±ï¼ˆåœ¨ç»§æ‰¿å…³ç³»ç±»å›¾ä¸­è¡¨ç°ä¸ºçºµå‘æ·±åº¦ï¼‰ã€ç»“æ„å¤æ‚ï¼ˆåœ¨ç»§æ‰¿å…³ç³»ç±»å›¾ä¸­è¡¨ç°ä¸ºæ¨ªå‘å¹¿åº¦ï¼‰çš„ç»§æ‰¿å…³ç³»ï¼Œè¶Šåº•å±‚çš„å­ç±»è¦mockçš„å¯¹è±¡å¯èƒ½å°±ä¼šè¶Šå¤šï¼Œè¿™æ ·å°±ä¼šå¯¼è‡´ï¼Œåº•å±‚å­ç±»åœ¨å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œè¦ä¸€ä¸ªä¸€ä¸ªmockå¾ˆå¤šä¾èµ–å¯¹è±¡ï¼Œè€Œä¸”è¿˜éœ€è¦æŸ¥çœ‹çˆ¶ç±»ä»£ç ï¼Œå»äº†è§£è¯¥å¦‚ä½•mockè¿™äº›ä¾èµ–å¯¹è±¡ã€‚</p><p>å¦‚æœæˆ‘ä»¬åˆ©ç”¨ç»„åˆè€Œéç»§æ‰¿æ¥ç»„ç»‡ç±»ä¹‹é—´çš„å…³ç³»ï¼Œç±»ä¹‹é—´çš„ç»“æ„å±‚æ¬¡æ¯”è¾ƒæ‰å¹³ï¼Œåœ¨ç¼–å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œåªéœ€è¦mockç±»æ‰€ç»„åˆä¾èµ–çš„å¯¹è±¡å³å¯ã€‚</p><h3>5.é«˜è€¦åˆä»£ç </h3><p>å¦‚æœä¸€ä¸ªç±»èŒè´£å¾ˆé‡ï¼Œéœ€è¦ä¾èµ–åå‡ ä¸ªå¤–éƒ¨å¯¹è±¡æ‰èƒ½å®Œæˆå·¥ä½œï¼Œä»£ç é«˜åº¦è€¦åˆï¼Œé‚£æˆ‘ä»¬åœ¨ç¼–å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œå¯èƒ½éœ€è¦mockè¿™åå‡ ä¸ªä¾èµ–çš„å¯¹è±¡ã€‚ä¸ç®¡æ˜¯ä»ä»£ç è®¾è®¡çš„è§’åº¦æ¥è¯´ï¼Œè¿˜æ˜¯ä»ç¼–å†™å•å…ƒæµ‹è¯•çš„è§’åº¦æ¥è¯´ï¼Œè¿™éƒ½æ˜¯ä¸åˆç†çš„ã€‚</p><h2>é‡ç‚¹å›é¡¾</h2><p>å¥½äº†ï¼Œä»Šå¤©çš„å†…å®¹åˆ°æ­¤å°±è®²å®Œäº†ã€‚æˆ‘ä»¬ä¸€å—æ¥æ€»ç»“å›é¡¾ä¸€ä¸‹ï¼Œä½ éœ€è¦é‡ç‚¹æŒæ¡çš„å†…å®¹ã€‚</p><p><strong>1.ä»€ä¹ˆæ˜¯ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Ÿ</strong></p><p>ç²—ç•¥åœ°è®²ï¼Œæ‰€è°“ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Œå°±æ˜¯é’ˆå¯¹ä»£ç ç¼–å†™å•å…ƒæµ‹è¯•çš„éš¾æ˜“ç¨‹åº¦ã€‚å¯¹äºä¸€æ®µä»£ç ï¼Œå¦‚æœå¾ˆéš¾ä¸ºå…¶ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œæˆ–è€…å•å…ƒæµ‹è¯•å†™èµ·æ¥å¾ˆè´¹åŠ²ï¼Œéœ€è¦ä¾é å•å…ƒæµ‹è¯•æ¡†æ¶ä¸­å¾ˆé«˜çº§çš„ç‰¹æ€§ï¼Œé‚£å¾€å¾€å°±æ„å‘³ç€ä»£ç è®¾è®¡å¾—ä¸å¤Ÿåˆç†ï¼Œä»£ç çš„å¯æµ‹è¯•æ€§ä¸å¥½ã€‚</p><p><strong>2.ç¼–å†™å¯æµ‹è¯•æ€§ä»£ç çš„æœ€æœ‰æ•ˆæ‰‹æ®µ</strong></p><p>ä¾èµ–æ³¨å…¥æ˜¯ç¼–å†™å¯æµ‹è¯•æ€§ä»£ç çš„æœ€æœ‰æ•ˆæ‰‹æ®µã€‚é€šè¿‡ä¾èµ–æ³¨å…¥ï¼Œæˆ‘ä»¬åœ¨ç¼–å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œå¯ä»¥é€šè¿‡mockçš„æ–¹æ³•è§£ä¾èµ–å¤–éƒ¨æœåŠ¡ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åœ¨ç¼–å†™å•å…ƒæµ‹è¯•çš„è¿‡ç¨‹ä¸­æœ€æœ‰æŠ€æœ¯æŒ‘æˆ˜çš„åœ°æ–¹ã€‚</p><p><strong>3.å¸¸è§çš„Anti-Patterns</strong></p><p>å¸¸è§çš„æµ‹è¯•ä¸å‹å¥½çš„ä»£ç æœ‰ä¸‹é¢è¿™5ç§ï¼š</p><ul>
<li>ä»£ç ä¸­åŒ…å«æœªå†³è¡Œä¸ºé€»è¾‘</li>
<li>æ»¥ç”¨å¯å˜å…¨å±€å˜é‡</li>
<li>æ»¥ç”¨é™æ€æ–¹æ³•</li>
<li>ä½¿ç”¨å¤æ‚çš„ç»§æ‰¿å…³ç³»</li>
<li>é«˜åº¦è€¦åˆçš„ä»£ç </li>
</ul><h2>è¯¾å ‚è®¨è®º</h2><ol>
<li>å®æˆ˜æ¡ˆä¾‹ä¸­çš„void fillTransactionId(String preAssignedId)å‡½æ•°ä¸­åŒ…å«ä¸€å¤„é™æ€å‡½æ•°è°ƒç”¨ï¼šIdGenerator.generateTransactionId()ï¼Œè¿™æ˜¯å¦ä¼šå½±å“åˆ°ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Ÿåœ¨å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯å¦éœ€è¦mockè¿™ä¸ªå‡½æ•°ï¼Ÿ</li>
<li>æˆ‘ä»¬ä»Šå¤©è®²åˆ°ï¼Œä¾èµ–æ³¨å…¥æ˜¯æé«˜ä»£ç å¯æµ‹è¯•æ€§çš„æœ€æœ‰æ•ˆçš„æ‰‹æ®µã€‚æ‰€ä»¥ï¼Œä¾èµ–æ³¨å…¥ï¼Œå°±æ˜¯ä¸è¦åœ¨ç±»å†…éƒ¨é€šè¿‡newçš„æ–¹å¼åˆ›å»ºå¯¹è±¡ï¼Œè€Œæ˜¯è¦é€šè¿‡å¤–éƒ¨åˆ›å»ºå¥½ä¹‹åä¼ é€’ç»™ç±»ä½¿ç”¨ã€‚é‚£æ˜¯ä¸æ˜¯æ‰€æœ‰çš„å¯¹è±¡éƒ½ä¸èƒ½åœ¨ç±»å†…éƒ¨åˆ›å»ºå‘¢ï¼Ÿå“ªç§ç±»å‹çš„å¯¹è±¡å¯ä»¥åœ¨ç±»å†…éƒ¨åˆ›å»ºå¹¶ä¸”ä¸å½±å“ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Ÿä½ èƒ½ä¸¾å‡ ä¸ªä¾‹å­å—ï¼Ÿ</li>
</ol><p>æ¬¢è¿åœ¨ç•™è¨€åŒºå†™ä¸‹ä½ çš„ç­”æ¡ˆï¼Œå’ŒåŒå­¦ä¸€èµ·äº¤æµå’Œåˆ†äº«ã€‚å¦‚æœæœ‰æ”¶è·ï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™ç¯‡æ–‡ç« åˆ†äº«ç»™ä½ çš„æœ‹å‹ã€‚</p><h2>ç²¾é€‰ç•™è¨€ï¼š</h2>
        <ul>
        
<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            å®‰é™çš„boy  2020-01-08 09:02:57
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            è¿™èŠ‚æ»¡æ»¡çš„å¹²è´§ğŸ‘ğŸ‘ğŸ‘ [9èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            å¤±ç«çš„å¤å¤©  2020-01-08 08:29:39
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            æ€è€ƒé¢˜1ï¼Œè¯¥æ–¹æ³•é€»è¾‘å°±æ˜¯å¡«å……ä¸€ä¸ªIDï¼ŒåŸºæœ¬éƒ½æ˜¯å†…éƒ¨å®ç°çš„ä¸€ä¸ªidç”Ÿæˆå™¨ï¼Œå¯ä»¥ä¸ç”¨é‡å†™ã€‚ä¸€å®šè¦é‡å†™ä¹Ÿè¡Œï¼Œè‡ªå·±å¼„ä¸€ä¸ªè‡ªå¢idå®ç°å°±è¡Œäº†ã€‚<br>æ€è€ƒé¢˜2ï¼Œæä¾›æ–¹æ³•çš„ç±»ä¸è¦newï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¸¸è¯´çš„serviceç±»ï¼Œè¿™ä¸ªæ˜¯è¦ä¾èµ–æ³¨å…¥çš„ã€‚æä¾›å±æ€§çš„ç±»ï¼Œæ¯”å¦‚voï¼Œboï¼Œentityè¿™äº›å°±å¯ä»¥newã€‚ [9èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            è¾£ä¹ˆå¤§  2020-01-08 09:22:17
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            å‚è€ƒäº‰å“¥ä»Šå¤©çš„ä»£ç å†™äº†ä¾‹å­ä¸­çš„æµ‹è¯•ï¼ˆå¯è¿è¡Œï¼‰ï¼š<br>https:&#47;&#47;github.com&#47;gdhucoder&#47;Algorithms4&#47;tree&#47;master&#47;designpattern&#47;u29<br><br>ä»Šå¤©å­¦ä¹ åˆ°äº†é«˜çº§çš„å•å…ƒæµ‹è¯•æ–¹æ³•ï¼š<br>1ã€ä¾èµ–å¤–éƒ¨å•ä¾‹ï¼šå°†å•ä¾‹å°è£…<br>2ã€æœªå†³è¡Œä¸ºï¼šä¾‹æ—¶é—´ã€éšæœºæ•°ã€‚å°†æœªå†³è¡Œä¸ºé‡æ–°å°è£…ï¼Œæµ‹è¯•æ—¶mockï¼Œä½¿ç”¨åŒ¿åç±»ã€‚<br><br> å…³äºè®¨è®º1ï¼šéœ€è¦mockçš„æƒ…å†µidä¼šå†™å…¥æ•°æ®åº“çš„è¯ï¼Œæµ‹è¯•åéœ€è¦æ¢å¤ç°åœºã€‚æ›¾ç»é‡åˆ°è¿‡è¿™ä¹ˆä¸€ä¸ªæƒ…å†µï¼Œidæ˜¯é€šè¿‡ä¸€å¼ è¡¨ç»´æŠ¤çš„ï¼Œå¤§äº0ï¼Œåœ¨ä»£ç ä¸­idçš„æ•°æ®ç±»å‹æ˜¯Integerï¼ˆé—ç•™ä»£ç ï¼‰ï¼Œç”±äºæµ‹è¯•æ—¶æ²¡æœ‰æ¢å¤ç°åœºï¼Œå¯¼è‡´æµ‹è¯•æ•°æ®åº“ä¸­idå¢åŠ è¿‡å¿«ï¼Œè¶…è¿‡äº†ä»£ç ä¸­Integerçš„è¡¨ç¤ºèŒƒå›´ï¼Œè€Œäº§ç”Ÿäº†æ„æƒ³ä¸åˆ°çš„é—®é¢˜ã€‚ [8èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            ä¸‹é›¨å¤©  2020-01-08 17:59:54
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            é—®é¢˜å›ç­”ï¼š<br>1. IdGenerator.generateTransactionId()æœ‰æœªå†³è¡Œä¸ºé€»è¾‘ï¼Œä½†ä¸æ˜¯è¯´æœ‰æœªå†³è¡Œä¸ºå°±ä¸€å®šå½±å“å¯æµ‹è¯•æ€§ï¼Œå‰ææ˜¯éœ€è¦çœ‹æœªå†³è¡Œä¸ºæ˜¯å¦æœ‰æµ‹è¯•å¿…è¦æ€§ï¼Œæ­¤å¤„ç”Ÿæˆä¸€ä¸ªéšæœºæ•°(ç±»ä¼¼ System.currentTimeMillis())ï¼Œæµ‹è¯•æ„ä¹‰ä¸å¤§ï¼<br><br>2.è´«è¡€æ¨¡å‹å®ä½“ç±» [2èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            QQæ€ª  2020-01-08 16:34:08
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            çœ‹åˆ°ä¸€åŠï¼Œæˆ‘å°±æ¥è¯„è®ºï¼Œè€å¸ˆæ”¶ä¸‹æˆ‘çš„è†ç›–ï¼Œå¤ªå¼ºäº† [2èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;        line-height:1.2">ä½œè€…å›å¤2020-01-08 21:06:29</div>
    <div style="color:#353535;font-weight:400;white-space:normal;        word-break:break-all;line-height:1.6">ğŸ˜ æ„Ÿè°¢è®¤å¯ï¼</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            é€é¥æ€  2020-01-08 15:04:45
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            1. ä¸ä¼šå½±å“å¯æµ‹è¯•æ€§ï¼Œå› ä¸º generateTransactionId å¹¶ä¸éœ€è¦ä¾èµ–ä»€ä¹ˆå¤–éƒ¨æœåŠ¡ï¼Œæ‰€ä»¥ä¹Ÿä¸éœ€è¦ mock<br>2. ä¸æ˜¯ã€‚ä¸ä¾èµ–å¤–éƒ¨æœåŠ¡çš„ç±»å°±å¯ä»¥å†…éƒ¨åˆ›å»ºï¼Œæ¯”å¦‚ String [2èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            æ¡‚åŸè€æ‰˜å°¼  2020-01-08 08:04:53
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            æ„Ÿè°¢äº‰å“¥åˆ†äº«<br>è¯¾åè®¨è®º1.idçš„ç”Ÿæˆé€»è¾‘æœ‰ç‚¹æ²¡çœ‹æ‡‚ï¼Œå•çº¯ä»ä»£ç è¦†ç›–ä¸Šçœ‹ï¼ŒfillTransactionId æœªè¦†ç›–å®Œå…¨ï¼Œéœ€è¦mockä¸‹è¿™ä¸ªé™æ€æ–¹æ³•ï¼Œå½“ç„¶ä¹Ÿæœ‰å…¶ä»–åˆ†æ”¯é€»è¾‘å¯ä»¥è¦†ç›–ã€‚<br>idæ²¡æœ‰åœ¨executeæ–¹æ³•ä¸­ä¸æ˜¯æ ¸å¿ƒå±æ€§(mockæ–¹æ³•çš„å…¥å‚)ï¼Œä¸å½±å“executeçš„å¯æµ‹è¯•æ€§ã€‚ idçš„ç”Ÿæˆç”¨é™æ€æ–¹æ³•çœŸçš„å¥½ä¹ˆï¼Ÿ<br>2.æœ‰è¡Œä¸ºçš„å¯¹è±¡ä¸é€‚åˆåœ¨ç±»ä¸­newï¼Œå°½é‡ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œä¾èµ–æ¥å£ç¼–ç¨‹ï¼Œè€Œä¸æ˜¯å…·ä½“çš„å®ç°ã€‚ æ•°æ®å¯¹è±¡é€‚åˆåœ¨ç±»ä¸­new æ¯”å¦‚å„ç§model do vo info ã€‚<br>ä¸€å®¶ä¹‹è¨€æ¬¢è¿è®¨è®ºæŒ‡æ­£ã€‚ [2èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            å¹³é£é€ é›¨  2020-01-08 12:45:02
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            &#47;&#47; æŠ½å–äº†å½“å‰æ—¶é—´è·å–çš„é€»è¾‘ï¼Œæ–¹ä¾¿æµ‹è¯•<br>    private long currentTimeMillis;<br>    private Date dueTime;<br>    public Demo(Date dueTime){<br>        this.dueTime = dueTime;<br>        this.currentTimeMillis = getCurrentTimeMillis();<br>    }<br><br>    protected long getCurrentTimeMillis(){<br>        return System.currentTimeMillis();<br>    }<br>    public long caculateDelayDays() {<br>        if(dueTime.getTime() &gt;= currentTimeMillis){<br>            return 0;<br>        }<br>        long delayTime = currentTimeMillis - dueTime.getTime();<br>        long delayDays = delayTime &#47; 86400_000;<br>        return delayDays;<br>    }<br>    @Test<br>    public void testCaculateDelayDays(){<br>        TimeZone timeZone = TimeZone.getTimeZone(&quot;Asia&#47;ShangHai&quot;);<br>        Calendar calendar = Calendar.getInstance(timeZone);<br>        calendar.clear();<br>        calendar.set(2020, Calendar.FEBRUARY,1,0,0,0);<br>        Date dueTime = calendar.getTime();<br>        Demo demo = new DemoClassOne(dueTime);<br>        Assert.assertEquals(demo.caculateDelayDays(), 0);<br>        calendar.clear();<br>        calendar.set(2019, Calendar.DECEMBER, 31, 0,0,0);<br>        dueTime = calendar.getTime();<br>        demo = new DemoClassOne(dueTime);<br>        Assert.assertEquals(demo.caculateDelayDays(), 1);<br>    }<br><br>    public static class DemoClassOne extends Demo {<br>        public DemoClassOne(Date dueTime) {<br>            super(dueTime);<br>        }<br>        @Override<br>        protected long getCurrentTimeMillis() {<br>            TimeZone timeZone = TimeZone.getTimeZone(&quot;Asia&#47;ShangHai&quot;);<br>            Calendar calendar = Calendar.getInstance(timeZone);<br>            calendar.clear();<br>            calendar.set(2020, Calendar.JANUARY,1,0,0,0);<br>            return calendar.getTimeInMillis();<br>        }<br>    } [1èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            Jesse  2020-01-08 10:23:03
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            æ€è€ƒé¢˜1ï¼Œè¯¥æ–¹æ³•äº§ç”Ÿä¸€ä¸ªå”¯ä¸€çš„ID,æˆ‘è®¤ä¸ºä¸éœ€è¦mockã€‚<br>æ€è€ƒé¢˜2ï¼Œæˆ‘è§‰å¾—å¦‚æœå¯¹è±¡æœ‰è¡Œä¸ºï¼Œå¹¶ä¸”è¡Œä¸ºä¸å¤–éƒ¨ç³»ç»Ÿäº¤äº’æˆ–è€…æ‰§è¡Œçš„ç»“æœå…·æœ‰ä¸ç¡®å®šæ€§ï¼Œå°±éœ€è¦ä¾èµ–æ³¨å…¥æ¥å®Œæˆæµ‹è¯•ã€‚å¦‚æœå¯¹è±¡çš„è¡Œä¸ºæ˜¯å¯é¢„æµ‹çš„å¹¶ä¸”å”¯ä¸€çš„ï¼Œå¯ä»¥ç›´æ¥newã€‚ [1èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            Kenå¼ äº‘å¿   2020-01-10 08:11:03
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            1.å®æˆ˜æ¡ˆä¾‹ä¸­çš„ void fillTransactionId(String preAssignedId) å‡½æ•°ä¸­åŒ…å«ä¸€å¤„é™æ€å‡½æ•°è°ƒç”¨ï¼šIdGenerator.generateTransactionId()ï¼Œè¿™æ˜¯å¦ä¼šå½±å“åˆ°ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Ÿåœ¨å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯å¦éœ€è¦ mock è¿™ä¸ªå‡½æ•°ï¼Ÿ<br>å¦‚æœgenerateTransactionId()ä¾èµ–äº†å¤–éƒ¨æœåŠ¡,å¦‚redis&#47;mysql&#47;zookeeperç­‰,å°±ä¼šå½±å“ä»£ç çš„å¯æµ‹è¯•æ€§,åœ¨å†™å•å…ƒæµ‹è¯•æ—¶å°±éœ€è¦mockè¿™ä¸ªå‡½æ•°;<br>å¦‚æœgenerateTransactionId()æ²¡æœ‰ä¾èµ–å¤–éƒ¨æœåŠ¡å°±ä¸ä¼šå½±å“ä»£ç çš„å¯æµ‹è¯•æ€§,å†™å•å…ƒæµ‹è¯•æ—¶ä¹Ÿä¸éœ€è¦mockè¿™ä¸ªå‡½æ•°.<br><br>2.ä¾èµ–æ³¨å…¥æ˜¯æé«˜ä»£ç å¯æµ‹è¯•æ€§çš„æœ€æœ‰æ•ˆçš„æ‰‹æ®µã€‚æ‰€ä»¥ï¼Œä¾èµ–æ³¨å…¥ï¼Œå°±æ˜¯ä¸è¦åœ¨ç±»å†…éƒ¨é€šè¿‡ new çš„æ–¹å¼åˆ›å»ºå¯¹è±¡ï¼Œè€Œæ˜¯è¦é€šè¿‡å¤–éƒ¨åˆ›å»ºå¥½ä¹‹åä¼ é€’ç»™ç±»ä½¿ç”¨ã€‚<br>é‚£æ˜¯ä¸æ˜¯æ‰€æœ‰çš„å¯¹è±¡éƒ½ä¸èƒ½åœ¨ç±»å†…éƒ¨åˆ›å»ºå‘¢ï¼Ÿå“ªç§ç±»å‹çš„å¯¹è±¡å¯ä»¥åœ¨ç±»å†…éƒ¨åˆ›å»ºå¹¶ä¸”ä¸å½±å“ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Ÿä½ èƒ½ä¸¾å‡ ä¸ªä¾‹å­å—ï¼Ÿ<br>ä¸æ˜¯.<br>æ²¡æœ‰ä¾èµ–å¤–éƒ¨æœåŠ¡çš„å¯¹è±¡å¯ä»¥åœ¨ç±»å†…éƒ¨åˆ›å»º,å¹¶ä¸”ä¸ä¼šå½±å“ä»£ç çš„å¯æµ‹è¯•æ€§.<br>ä¾‹å¦‚new Date()æ²¡æœ‰ä¾èµ–å¤–éƒ¨æœåŠ¡,åªæ˜¯è°ƒç”¨äº†æœ¬æœºæ“ä½œç³»ç»Ÿçš„æ—¶é—´å‡½æ•°. 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            è¾¾æ–‡è¥¿  2020-01-09 20:58:12
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            å†…å®¹éƒ½æ˜¯å¹²è´§,ä¸å¤Ÿçœ‹å•Š 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            whistleman  2020-01-09 14:09:13
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            ä¸€ç›´æä¸æ‡‚å•å…ƒæµ‹è¯•æ€ä¹ˆå†™ï¼Œäºæ˜¯å°±ä¸å–œæ¬¢å†™ï¼Œè·Ÿç€è¿™èŠ‚è¯¾æ•²äº†ä»£ç ï¼Œå­¦åˆ°äº†å¥½å¤šã€‚æ„Ÿè§‰çŸ¥é“æ€ä¹ˆå»å†™ï¼Œæ„Ÿè§‰è‡ªå·±ä¸€ä¸‹å˜å¼ºäº†ï¼Œäº‰å“¥å¤ªå¼ºäº†ï¼Œ666 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            #HEAVEN  2020-01-08 22:58:08
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            ä½ å¥½ï¼Œæ²¡æœ‰æ‰¾åˆ°ä½œè€…é‚®ç®±ï¼Œæƒ³é—®ä¸€ä¸ªé—®é¢˜ï¼›<br>ä½œè€…åœ¨å¼€å‘ä¸€ä¸ªéœ€æ±‚çš„æ—¶å€™æ˜¯æ€æ ·çš„ä¸€ä¸ªæµç¨‹ï¼Œè®¾è®¡åšåˆ°é‚£ç§ç¨‹åº¦ï¼Ÿ<br>æ¯”å¦‚è¯´ä¸€èˆ¬æˆ‘ä¼šåš1. éœ€æ±‚åˆ†æï¼Œåˆ—å‡ºå“ªäº›éœ€æ±‚caseï¼› 2. åˆ—å‡ºè¿™äº›caseéœ€è¦å¼€å‘å“ªäº›åŠŸèƒ½ç‚¹ï¼›3. ä¸»è¦æ¶‰åŠåˆ°å“ªäº›ç±»ï¼Œç»“æ„å¦‚ä½•ç»„ç»‡ï¼›4. ä¸»è¦ç±»çš„ä¸»è¦èŒè´£ç­‰ï¼›5. å¼€å§‹codeäº†ï¼›<br>åœ¨å¼€å‘çš„è¿‡ç¨‹ä¸­ä¹Ÿä¼šé‡åˆ°ä¸€äº›é—®é¢˜ï¼Œæ¯”å¦‚ï¼Œæœ‰æ—¶å€™æœ‰äº›ç±»çš„èŒè´£æˆ–è€…ç»“æ„å¼€å§‹çš„è®¾è®¡ä¸å¤ªåˆç†ï¼Œéœ€è¦ä¸€äº›ä¿®æ”¹ï¼›è¿™ä¸ªæ—¶å€™æˆ‘å°±åœ¨æ€€ç–‘ï¼Œæ˜¯ä¸æ˜¯å‰æœŸåšçš„è®¾è®¡ä¸å¤Ÿå……åˆ†é€ æˆçš„ã€‚ä¹Ÿçœ‹åˆ°ä¸€äº›ä¹¦ä¸Šä¼šæŠŠç±»çš„å±æ€§ã€æ–¹æ³•éƒ½è®¾è®¡å‡ºæ¥ï¼Œè¿˜æœ‰ä¸»è¦æµç¨‹caseçš„åºåˆ—å›¾ï¼›ä½†æ˜¯è¿™æ ·åšè€—æ—¶è¾ƒå¤šï¼Œå¾ˆå¤šæ—¶å€™é¡¹ç›®æ—¥ç¨‹ä¸å…è®¸ã€‚<br>åƒé—®ä¸€ä¸‹ï¼Œä½œè€…åœ¨å¼€å‘ä¸­è®¾è®¡é˜¶æ®µæœ‰å“ªäº›æµç¨‹ï¼Œåšåˆ°ä»€ä¹ˆç¨‹åº¦ï¼Ÿ<br>ç•™ä¸ªé‚®ç®±æ–¹ä¾¿äº¤æµå°±æ›´å¥½äº† 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            è€éº’ç¿  2020-01-08 21:36:14
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            å¯¹äºIdGenerator.generateTransactionId()ï¼Œè™½ç„¶æ˜¯æœªå†³è¡Œä¸ºï¼Œä¸ªäººè®¤ä¸ºåªæ˜¯ç”Ÿæˆä¸€ä¸ªidäº†è¯ï¼Œå¹¶ä¸ä¼šåŒ…å«éå¸¸å¤æ‚çš„é€»è¾‘æ“ä½œï¼Œåº”è¯¥å°±è·ŸMath.abs()ç±»ä¼¼ï¼Œä¸éœ€è¦è¿›è¡Œmock 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            å†è§å­™æ‚Ÿç©º  2020-01-08 21:15:06
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            ä»Šå¤©è€å¸ˆè®²çš„ä¸ºäº†æ›´å¥½çš„å•å…ƒæµ‹è¯•è€Œè¿›è¡Œçš„é‡æ„ï¼ŒåŸæ¥å·¥ä½œä¸­æ— å½¢é—´å·²ç»ç”¨åˆ°äº†ã€‚åœ¨å¯¹æ¥ä¸‰æ–¹ api æ—¶ï¼Œæœ‰æ—¶å€™ç¼ºå°‘å¿…è¦çš„å‚æ•°ä¿¡æ¯ï¼Œæˆ‘ä»¬åªèƒ½æ¨¡æ‹Ÿè°ƒé€šï¼Œè¿™æ—¶å€™æˆ‘ä»¬å°±å†™ä¸€ä¸ªç±»ç»§æ‰¿åŸå§‹ç±»ï¼Œé‡å†™åŸæ–¹æ³•ï¼Œè¿”å›è‡ªå·±éœ€è¦çš„æ•°æ®ï¼Œä¸è¿‡è¿˜æœ‰å¾ˆå¤šåšçš„ä¸è¶³ï¼Œä¾‹å¦‚å¯¹äºä¸ç¡®å®šæ•°æ®çš„mock æ²¡æœ‰æŠ½æˆæ–¹æ³•ç­‰ï¼ŒæŒç»­å­¦ä¹ ï¼Œè€å¸ˆæ£’ï¼ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            æ–æ³¢é‚£å¥‘  2020-01-08 20:09:37
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            æ„Ÿè§‰é‚£ä¸ªcreatetimestampé‚£è¾¹ å¦‚æœæ²¡æœ‰setæ–¹æ³•åº”è¯¥å¯ä»¥ç”¨åå°„å»ä¿®æ”¹è¿™ä¸ªå±æ€§<br><br>æ€è€ƒé¢˜1 å¯ä»¥ä¸mock å› ä¸ºæ‰§è¡Œidgeneratorä¹‹å‰æœ‰é€»è¾‘åˆ¤æ–­çš„ åªè¦ä¼ å…¥è¿›å»çš„å‚æ•°ä¸æ»¡è¶³æ¡ä»¶å°±ä¸ä¼šèµ° å…¶æ¬¡å¯¹äºidå¼€å¤´æ·»åŠ t_è¿™ä¸ªé€»è¾‘è·Ÿidç”Ÿæˆå™¨æ²¡æœ‰å…³ç³» åªè¦ä¿è¯é€ å‡ºæ¥åˆ°idæ²¡æœ‰t_å¼€å¤´å°±å¯ä»¥æµ‹è¯•<br><br>æ€è€ƒé¢˜2 å…¶å®æœ€è¿‘åœ¨å†™ä¸€ä¸ªéœ€æ±‚ æˆ‘å°±ç”¨äº†å†…éƒ¨ç±» ä¹Ÿè§‰å¾—å¹¶æ²¡æœ‰ç ´åæµ‹è¯•æ€§ æˆ‘è¿™ä¸ªå†…éƒ¨ç±»ä¸»è¦æ˜¯ä¸ºäº†éšè—æŸä¸ªæ¥å£çš„å®ç° ä¸æƒ³è¢«è°ƒç”¨è€…åœ¨ä½¿ç”¨å¤–éƒ¨ç±»æ—¶æ»¥ç”¨æˆ‘çš„æ¯ä¸€ä¸ªæ¥å£å®ç°æ–¹æ³• èµ·åˆ°ä¸€ä¸ªä¿æŠ¤ä½œç”¨ å¯¹äºæµ‹è¯•æ€§ å®Œå…¨å¯ä»¥é€šè¿‡ä¸åŒçš„å¤–éƒ¨ç±»å‚æ•°æ¥è¿›è¡Œè°ƒæ•´ å…¶å®å¯¹äºå†…éƒ¨ç±»çš„å¯æµ‹è¯•æ€§æ¥è®² åªè¦å¤–éƒ¨ç±»æœ‰è¶³å¤Ÿçš„å‚æ•°æ¥æ§åˆ¶å†…éƒ¨ç±»å°±å¯ä»¥ å¯¹äºå†…éƒ¨ç±»è°ƒç”¨ç¬¬ä¸‰æ–¹çš„æƒ…å†µ åªè¦å¤–éƒ¨ç±»æœ‰å‚æ•°å¯ä»¥æ³¨å…¥å°±å¯ä»¥ç”¨mockæ¥ä¿®æ”¹å†…éƒ¨ç±»çš„å®ç° 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            Jxin  2020-01-08 12:57:38
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            1.æ ä¸»å¥½åƒæè¿‡ï¼Œè¦è°ˆè°ˆåˆ†å±‚å¯¹äºå¯æµ‹è¯•æ€§çš„å½±å“ï¼Œä¸çŸ¥æ˜¯ä¸æ˜¯æˆ‘è®°é”™äº†ï¼Œè¿™ç¯‡æ²¡æåˆ°å“ˆã€‚<br><br>å›ç­”é—®é¢˜<br>1.äº¤æ˜“idè¿™ä¸œè¥¿ï¼Œæ˜¯å…¨å±€å”¯ä¸€çš„ã€‚ä¸è¯¥è¢«mockï¼Œmockäº†ä¸ä»…æ²¡ç”¨ï¼Œåè€Œå¯èƒ½ä¼šæœ‰å…¶ä»–é—®é¢˜ï¼ˆå¦‚æœæœ‰å¼•å…¥å”¯ä¸€é”®æ£€éªŒç›¸å…³æœºåˆ¶çš„è¯ï¼Œæ¯”å¦‚å¹‚ç­‰å•¥çš„ï¼‰ã€‚<br><br>2.å€¼å¯¹è±¡å¯ä»¥newï¼Œå› ä¸ºå€¼å¯¹è±¡ä¸ä¼šæœ‰æ¶‰åŠæ”¹åŠ¨è‡ªèº«å±æ€§çš„æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´å®ƒé€šå¸¸æ˜¯ä¸å¯å˜çš„ï¼Œæ‰€ä»¥ä¹Ÿæ²¡ä»€ä¹ˆæ£€éªŒçš„æ„ä¹‰ã€‚è€Œå®ä½“é¢†åŸŸæ¨¡å‹ä¸ä¸€å®šå¯ä»¥newï¼Œå› ä¸ºå…¶æ–¹æ³•ä¼šæ”¹å˜è‡ªèº«å±æ€§ï¼Œè€Œå¯¹è¿™äº›å±æ€§å˜åŠ¨ï¼Œæœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦æ ¡éªŒã€‚è€Œè´«è¡€å®ä½“dtoæˆ–doä¹‹ç±»çš„ï¼Œä¸€èˆ¬ä¹Ÿå¯ä»¥newï¼Œå› ä¸ºå®ƒåªæ‰¿æ¥å±æ€§ï¼Œåœºæ™¯ç±»ä¼¼å€¼å¯¹è±¡ï¼Œåªéœ€è¦å…³å¿ƒæ–¹æ³•è¿”å›çš„dtoæˆ–voçš„å€¼å³å¯ï¼Œæ— éœ€å…³å¿ƒæ–¹æ³•å†…éƒ¨æ˜¯newè¿˜æ˜¯æ³¨å…¥çš„ï¼ˆå¯¹äºæ–¹æ³•è€Œè¨€ï¼Œé™¤äº†ç±»æˆå‘˜å±æ€§çš„æ³¨å…¥ï¼Œæ–¹æ³•å…¥å‚ä¹Ÿç®—æ³¨å…¥å§ï¼‰ã€‚ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            æå°å››  2020-01-08 11:41:09
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            è®¾è®¡æ¨¡å¼_29:<br><br>1. æˆ‘è®¤ä¸ºé™æ€æ–¹æ³•```IdGenerator.generateTransactionId()```ä¸éœ€è¦mockï¼Œå› ä¸ºå®ƒä¸ä¼šå¾ˆè€—æ—¶(å¦‚æœå®ç°æ¯”è¾ƒæ­£å¸¸)ï¼Œä¹Ÿæ²¡æœ‰æœªå†³è¡Œä¸ºï¼Œé™¤éå¯¹äºidæœ‰ç‰¹æ®Šçš„è¦æ±‚ï¼Œå¦åˆ™ä¸éœ€è¦mockã€‚<br><br>2. è¿™é“é¢˜æˆ‘æƒ³ä¸æ¸…æ¥šï¼Œæƒ³çœ‹çœ‹ç‹äº‰è€å¸ˆå’Œå¤§å®¶çš„çœ‹æ³•ã€‚ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            æ­¤é±¼ä¸å¾—æ°´  2020-01-08 11:22:11
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            1. æœªå†³è¡Œä¸º ä¸­æåˆ°çš„å•æµ‹ï¼Œå¯ä»¥æŠŠä¸ç¡®å®šçš„å˜é‡â€˜å½“å‰æ—¶é—´â€™æå–å‡ºæ¥ä½œä¸ºå…¥å‚ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;            line-height:1.2">
            å®ˆæ‹™  2020-01-08 10:38:14
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;            word-break:break-all;line-height:1.6">
            è¯¾å ‚è®¨è®º:<br><br><br><br>Q1.å®æˆ˜æ¡ˆä¾‹ä¸­çš„ void fillTransactionId(String preAssignedId) å‡½æ•°ä¸­åŒ…å«ä¸€å¤„é™æ€å‡½æ•°è°ƒç”¨ï¼šIdGenerator.generateTransactionId()ï¼Œè¿™æ˜¯å¦ä¼šå½±å“åˆ°ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Ÿåœ¨å†™å•å…ƒæµ‹è¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ˜¯å¦éœ€è¦ mock è¿™ä¸ªå‡½æ•°ï¼Ÿ<br><br><br><br>Answer1: <br><br>ç†è®ºä¸Šè®²fill()æ–¹æ³•ç”±äºå†…éƒ¨é™æ€æ–¹æ³•çš„ä½¿ç”¨,åŠidç”Ÿæˆçš„æœªå†³è¡Œä¸º,å½±å“å¯æµ‹è¯•æ€§.<br><br>è§£å†³æ–¹æ³•æ˜¯ä¸ºfill()æ–¹æ³•æ·»åŠ ä¸€ä¸ªå½¢å‚,generateId,å¦‚ä¸‹:<br><br>void fillTransactionId(@Nullable String preAssignedId, @Nullable String generateId)<br><br>ä½†è¿™æ ·åšä¼šå½±å“å°è£…æ€§.fill()æ–¹æ³•å†…éƒ¨é€»è¾‘ç®€å•,å¯¹å¯æµ‹è¯•æ€§çš„å½±å“æ˜¯å¾®ä¸è¶³é“çš„.é™¤éæµ‹è¯•é—®é¢˜ç›´æŒ‡fill()æ–¹æ³•,å¦åˆ™ä¸ªäººå€¾å‘äºä¸åšä¿®æ”¹.<br><br><br><br>Q2.æˆ‘ä»¬ä»Šå¤©è®²åˆ°ï¼Œä¾èµ–æ³¨å…¥æ˜¯æé«˜ä»£ç å¯æµ‹è¯•æ€§çš„æœ€æœ‰æ•ˆçš„æ‰‹æ®µã€‚æ‰€ä»¥ï¼Œä¾èµ–æ³¨å…¥ï¼Œå°±æ˜¯ä¸è¦åœ¨ç±»å†…éƒ¨é€šè¿‡ new çš„æ–¹å¼åˆ›å»ºå¯¹è±¡ï¼Œè€Œæ˜¯è¦é€šè¿‡å¤–éƒ¨åˆ›å»ºå¥½ä¹‹åä¼ é€’ç»™ç±»ä½¿ç”¨ã€‚é‚£æ˜¯ä¸æ˜¯æ‰€æœ‰çš„å¯¹è±¡éƒ½ä¸èƒ½åœ¨ç±»å†…éƒ¨åˆ›å»ºå‘¢ï¼Ÿå“ªç§ç±»å‹çš„å¯¹è±¡å¯ä»¥åœ¨ç±»å†…éƒ¨åˆ›å»ºå¹¶ä¸”ä¸å½±å“ä»£ç çš„å¯æµ‹è¯•æ€§ï¼Ÿä½ èƒ½ä¸¾å‡ ä¸ªä¾‹å­å—ï¼Ÿ<br><br><br><br>Answer2: å†…éƒ¨ç±»æˆ–é™æ€å†…éƒ¨ç±», å±€éƒ¨ç±»çš„å¯¹è±¡å¯ä»¥åœ¨ç±»å†…éƒ¨é€šè¿‡new çš„æ–¹å¼åˆå§‹åŒ–.å®ƒä»¬æ˜¯å¤–éƒ¨ç±»è¡Œä¸ºçš„ä¸€éƒ¨åˆ†,ä»…ä¸ºå¤–éƒ¨ç±»è‡ªå·±ä½¿ç”¨,ä¸å½±å“æµ‹è¯•æ€§.<br><br><br><br>å¯¹äºæœªå†³è¡Œä¸ºæ–¹æ³•çš„æ”¹é€ :<br><br>before: <br><br><br><br>public class Demo { <br><br>public long caculateDelayDays(Date dueTime){<br><br> long currentTimestamp = System.currentTimeMillis();<br><br> if (dueTime.getTime() &gt;= currentTimestamp) { return 0; } <br><br>long delayTime = currentTimestamp - dueTime.getTime();<br><br> long delayDays = delayTime &#47; 86400; <br><br>return delayDays; <br><br>â€‹    }<br><br>}<br><br><br><br>after:<br><br>public class Demo { <br><br>public long caculateDelayDays(Date dueTime, Date currentTime){<br><br>â€‹     long currentTimestamp = currentTime.getTime();<br><br>â€‹     if (dueTime.getTime() &gt;= currentTimestamp) { return 0; } <br><br>â€‹     long delayTime = currentTimestamp - dueTime.getTime();<br><br>â€‹     long delayDays = delayTime &#47; 86400; <br><br>â€‹     return delayDays; <br><br>â€‹    }<br><br>} 
        </div>
        
    </div>
</li>
            </ul>
</div>
</body>
</html>